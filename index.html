<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ROAD TO SUPERMAN | V27</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Chakra+Petch:ital,wght@0,400;0,600;0,700;1,700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        
        /* NATIVE APP BEHAVIOR */
        html { touch-action: manipulation; -webkit-text-size-adjust: 100%; overscroll-behavior-y: none; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            color: #f8fafc; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
            user-select: none; 
            -webkit-user-select: none;
            padding-top: env(safe-area-inset-top); /* Notch support */
        }
        input { user-select: text; -webkit-user-select: text; font-size: 16px !important; }

        .font-tech { font-family: 'Chakra Petch', sans-serif; }
        .font-logo { font-family: 'Russo One', sans-serif; }

        /* ANIMATED BACKGROUND */
        .bg-aurora {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle at 50% -20%, #0f172a 0%, #000000 80%);
            pointer-events: none;
        }
        .bg-aurora::after {
            content: ''; position: absolute; inset: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
            opacity: 0.4;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }
        
        /* IRON MASK HEADER (Cache solide) */
        .header-solid {
            background-color: #020617;
            position: sticky; top: 0; z-index: 50;
            margin-left: -1rem; margin-right: -1rem; padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 -50px 0 50px #020617, 0 10px 30px rgba(0,0,0,0.8);
        }

        /* BUTTONS - TOUCH OPTIMIZED */
        .hero-btn {
            width: 54px; height: 54px; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; font-size: 1.8rem; color: #94a3b8; transition: transform 0.1s; cursor: pointer;
        }
        .hero-btn:active { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: white; transform: scale(0.9); }

        .stepper-btn {
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1); border-radius: 10px; font-weight: bold; transition: transform 0.1s;
        }
        .stepper-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.9); }

        .set-btn { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .set-btn.done {
            background: #2563eb; color: white; border-color: #2563eb;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.6); transform: scale(1.1);
        }
        
        /* LOGO */
        .logo-container { text-align: center; margin-top: 1.5rem; margin-bottom: 1rem; }
        .logo-top { font-family: 'Chakra Petch', sans-serif; font-size: 0.9rem; letter-spacing: 0.4em; color: #94a3b8; font-weight: 700; margin-bottom: -5px; text-transform: uppercase; }
        .logo-main { 
            font-family: 'Russo One', sans-serif; font-size: 3rem; line-height: 1;
            background: linear-gradient(180deg, #ffffff 20%, #3b82f6 90%); -webkit-background-clip: text; color: transparent;
            text-shadow: 0 0 30px rgba(37, 99, 235, 0.6); letter-spacing: 1px; text-transform: uppercase;
        }

        .modal-enter { transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
        .modal-enter-start { opacity: 0; transform: scale(0.95); }
        .modal-enter-end { opacity: 1; transform: scale(1); }
        
        .cardio-gradient { background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(234, 88, 12, 0.05)); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body x-data="app()" x-init="initApp()" class="h-screen flex flex-col text-slate-200">

    <div class="bg-aurora"></div>
    
    <div class="absolute top-6 left-4 z-50 flex items-center gap-3">
        <div class="flex items-center gap-1.5" :class="syncStatus === 'online' ? 'text-green-400' : 'text-red-500'">
            <div class="w-1.5 h-1.5 rounded-full" :class="syncStatus === 'online' ? 'bg-green-400 animate-pulse' : 'bg-red-500'"></div>
            <span class="text-[8px] font-mono uppercase tracking-widest" x-text="syncStatus === 'online' ? 'SYNC' : 'OFFLINE'"></span>
        </div>
        <div class="flex items-center gap-1 bg-orange-500/10 px-2 py-0.5 rounded-full border border-orange-500/20" x-show="streak > 0">
            <i data-lucide="flame" class="w-3 h-3 text-orange-500 fill-orange-500 animate-pulse"></i>
            <span class="text-[9px] font-bold text-orange-400" x-text="streak + ' Jours'"></span>
        </div>
    </div>

    <div class="logo-container">
        <div class="logo-top">ROAD TO</div>
        <div class="logo-main">SUPERMAN</div>
    </div>

    <header class="flex-none px-6 pb-2 pt-1 flex justify-between items-center z-20">
        <div class="relative w-full">
            <div class="flex justify-between text-[10px] uppercase font-bold mb-1 text-blue-300 font-tech">
                <span>SEMAINE <span x-text="currentWeek"></span> • LVL <span x-text="userLevel"></span></span>
                <span x-text="Math.floor(xp) + ' XP'"></span>
            </div>
            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden border border-white/10 shadow-inner">
                <div class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-1000" :style="`width: ${xpProgress}%`"></div>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 pb-40 relative scroll-smooth" id="scroller">
        
        <div x-show="tab === 'home'" class="space-y-5" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95">
            
            <div class="glass-panel rounded-3xl p-6 relative overflow-hidden group text-center border border-blue-500/20">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-blue-600/20 rounded-full blur-[80px] -mt-20"></div>
                
                <div class="flex justify-between items-center mb-4 relative z-10">
                     <p class="text-[10px] text-blue-300 font-bold uppercase tracking-[0.2em] font-tech text-center w-full">Cible : 85.0 KG</p>
                     <button @click="openWeightHistory()" class="absolute right-0 top-0 p-2 text-slate-400 hover:text-white bg-white/5 rounded-lg hover:bg-white/10 transition active:scale-90"><i data-lucide="clipboard-list" class="w-4 h-4"></i></button>
                </div>
                
                <div class="flex items-center justify-center gap-6 relative z-10 mb-4">
                    <button @click="updateWeight(-0.1)" class="hero-btn hover:text-white hover:border-blue-500"><i data-lucide="minus" class="w-6 h-6"></i></button>
                    
                    <div class="flex flex-col items-center w-40 cursor-pointer active:scale-95 transition-transform" @click="openWeightHistory()">
                        <span class="text-6xl font-logo text-white tabular-nums tracking-tight leading-none drop-shadow-2xl" x-text="currentWeight.toFixed(1)"></span>
                        <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-2">Kilogrammes</span>
                    </div>
                    
                    <button @click="updateWeight(0.1)" class="hero-btn hover:text-white hover:border-blue-500"><i data-lucide="plus" class="w-6 h-6"></i></button>
                </div>

                <div class="inline-block bg-black/40 px-3 py-1 rounded-full border border-white/5 backdrop-blur-sm">
                    <span class="text-[10px] font-mono text-red-400 font-bold">Déficit Actif : -1375 kcal</span>
                </div>
                <div class="h-16 w-full mt-6 opacity-70"><canvas id="weightChart"></canvas></div>
            </div>

            <div class="glass-panel rounded-2xl p-5">
                <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-2">
                    <i data-lucide="flask-conical" class="w-4 h-4 text-slate-400"></i>
                    <h3 class="text-xs font-bold text-slate-300 uppercase font-tech tracking-wider">Bio-Hacking Stack</h3>
                </div>
                <div class="grid grid-cols-4 gap-3">
                    <template x-for="(supp, key) in supplementsInfo">
                        <button @click="openSupp(key)" class="bg-slate-900/50 border border-white/5 rounded-2xl p-3 flex flex-col items-center gap-2 transition active:scale-95 hover:border-white/20 group shadow-sm">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg" :class="supp.bg">
                                <i :data-lucide="supp.icon" class="w-5 h-5" :class="supp.color"></i>
                            </div>
                            <span class="text-[9px] font-bold uppercase text-slate-500 group-hover:text-white transition-colors" x-text="supp.short"></span>
                        </button>
                    </template>
                </div>
            </div>

            <div @click="activeNutri = true" class="glass-panel rounded-2xl p-5 border-l-4 relative overflow-hidden cursor-pointer hover:border-white/20 transition active:scale-[0.99]" :class="isHighCarb() ? 'border-l-green-500' : 'border-l-yellow-500'">
                <div class="absolute right-0 top-0 opacity-10 p-4"><i :data-lucide="isHighCarb() ? 'zap' : 'flame'" class="w-16 h-16"></i></div>
                <div class="relative z-10">
                     <div class="flex justify-between items-center mb-3">
                        <div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase font-tech flex items-center gap-1">Cycle Métabolique <i data-lucide="info" class="w-3 h-3"></i></div>
                            <div class="text-2xl font-bold font-logo" :class="isHighCarb() ? 'text-green-400' : 'text-yellow-400'" x-text="isHighCarb() ? 'HIGH CARB' : 'LOW CARB'"></div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-white font-logo tracking-tighter" x-text="macros.calories"></div>
                            <div class="text-[9px] text-slate-500 uppercase tracking-widest">Kcal Target</div>
                        </div>
                     </div>
                     <div class="space-y-3">
                        <div class="flex items-center gap-3 text-[9px] font-bold text-slate-400">
                            <span class="w-8 text-blue-400">PROT</span>
                            <div class="flex-1 h-2 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-blue-500 rounded-full" style="width: 50%"></div></div>
                            <span class="text-white w-10 text-right" x-text="macros.protein + 'g'"></span>
                        </div>
                        <div class="flex items-center gap-3 text-[9px] font-bold text-slate-400">
                            <span class="w-8 text-yellow-400">LIP</span>
                            <div class="flex-1 h-2 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-yellow-500 rounded-full" style="width: 30%"></div></div>
                            <span class="text-white w-10 text-right" x-text="macros.fats + 'g'"></span>
                        </div>
                        <div class="flex items-center gap-3 text-[9px] font-bold text-slate-400">
                            <span class="w-8 text-green-400">GLU</span>
                            <div class="flex-1 h-2 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-green-500 rounded-full" :style="`width: ${isHighCarb() ? '60%' : '20%'}`"></div></div>
                            <span class="text-white w-10 text-right" x-text="isHighCarb() ? macros.carbsHigh + 'g' : macros.carbsLow + 'g'"></span>
                        </div>
                     </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-8 text-center border border-emerald-500/30 relative overflow-hidden bg-[#020617] shadow-[0_0_30px_rgba(16,185,129,0.1)]">
                <div class="absolute inset-0 bg-gradient-to-b from-emerald-900/10 to-transparent"></div>
                <div class="relative z-10">
                    <div class="mb-4 inline-flex items-center justify-center w-12 h-12 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 animate-pulse">
                        <i data-lucide="brain-circuit" class="w-6 h-6"></i>
                    </div>
                    <p class="text-lg font-bold text-white leading-relaxed font-tech italic mb-4" x-text="'&quot;' + randomFact.text + '&quot;'"></p>
                    <div class="flex justify-center items-center gap-3">
                         <span class="text-[9px] text-emerald-600 font-bold uppercase tracking-widest bg-emerald-900/20 px-2 py-1 rounded" x-text="randomFact.source"></span>
                         <button @click="generateFact()" class="text-slate-600 hover:text-white transition active:scale-90"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="h-20"></div>
        </div>

        <div x-show="tab === 'train'" class="space-y-4" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-x-10 opacity-0">
            
            <div class="header-solid">
                <div class="flex justify-between items-center mb-3 bg-white/5 p-1.5 rounded-xl mx-1 border border-white/10">
                    <button @click="changeWeek(-1)" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/10 rounded-lg transition active:scale-90"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <div class="text-center">
                         <span class="text-[10px] text-slate-500 uppercase font-bold tracking-widest block">Planning</span>
                        <span class="text-sm font-bold text-white font-tech uppercase">Semaine <span class="text-blue-400 text-base" x-text="currentWeek"></span></span>
                    </div>
                    <button @click="changeWeek(1)" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/10 rounded-lg transition active:scale-90"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
                <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1 justify-center">
                    <template x-for="day in splitOrder">
                        <button @click="selectedDay = day" class="px-4 py-2.5 rounded-xl text-[10px] font-bold uppercase border transition-all whitespace-nowrap font-tech"
                        :class="selectedDay === day ? 'bg-blue-600 border-blue-500 text-white shadow-lg shadow-blue-900/50' : 'bg-slate-800/50 border-slate-700 text-slate-500'">
                            <span x-text="day"></span>
                        </button>
                    </template>
                </div>
            </div>

            <div @click="openCardioInfo()" class="glass-panel p-5 rounded-2xl border border-orange-500/30 cardio-gradient relative overflow-hidden cursor-pointer hover:border-orange-500/50 transition active:scale-[0.99] group">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-orange-500/10 rounded-full blur-xl"></div>
                <div class="flex items-center gap-3 mb-3 relative z-10">
                    <div class="w-10 h-10 rounded-lg bg-orange-500/20 flex items-center justify-center text-orange-400 border border-orange-500/30">
                        <i data-lucide="flame" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-orange-400 text-sm uppercase font-tech flex items-center gap-2">
                            Protocole S<span x-text="currentWeek"></span> <i data-lucide="info" class="w-3 h-3 text-orange-400/50"></i>
                        </h3>
                        <p class="text-[10px] text-slate-400">Matin & Soir • <span x-text="getCardioData().summary"></span></p>
                    </div>
                </div>
                
                <div @click.stop class="flex items-center gap-3 bg-orange-500/10 p-3 rounded-xl border border-orange-500/20 hover:bg-orange-500/20 transition cursor-pointer" @click="toggleCardio()">
                    <div class="w-5 h-5 rounded border border-orange-500 bg-slate-900 flex items-center justify-center transition-colors" :class="daily.cardioDone ? 'bg-orange-500' : ''">
                        <i data-lucide="check" class="w-3 h-3 text-white" x-show="daily.cardioDone"></i>
                    </div>
                    <span class="text-[10px] font-bold text-orange-200 uppercase tracking-wide" x-text="daily.cardioDone ? 'Mission Validée (+50 XP)' : 'Valider Mission (+50 XP)'"></span>
                </div>
            </div>

            <div class="space-y-4 pb-10">
                <template x-for="(ex, index) in getExercises(selectedDay)" :key="index">
                    <div class="glass-panel rounded-2xl overflow-hidden border-l-4 relative transition-all duration-300" :class="ex.isPopeye ? 'border-l-green-500' : 'border-l-blue-500'">
                        <div x-show="ex.isPopeye" class="absolute top-0 right-0 bg-green-500/20 text-green-400 text-[8px] px-3 py-1 rounded-bl-xl font-bold font-tech tracking-wider">POPEYE</div>

                        <div class="p-5">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1 pr-2">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <h4 @click="openExerciseInfo(ex)" class="font-bold text-white text-base font-tech border-b border-dashed border-slate-600 cursor-help hover:text-blue-400 transition" x-text="ex.name"></h4>
                                        <span class="text-[8px] bg-slate-800 text-slate-400 border border-slate-700 px-1.5 py-0.5 rounded uppercase font-bold tracking-wide" x-text="ex.target"></span>
                                    </div>
                                    <div class="flex gap-2 mt-2 items-center flex-wrap">
                                        <div class="flex items-center gap-1.5 text-[10px] bg-blue-900/30 text-blue-300 px-2 py-1 rounded-lg border border-blue-500/30 font-mono">
                                            <i data-lucide="timer" class="w-3 h-3"></i>
                                            <span x-text="ex.tempo"></span>
                                        </div>
                                        <div class="text-[10px] bg-white/5 px-2 py-1 rounded-lg text-slate-300 font-bold" x-text="ex.reps + ' Reps'"></div>
                                        <button @click="openYoutube(ex.name)" class="flex items-center gap-1 bg-red-600/10 border border-red-600/40 text-red-500 px-2 py-1 rounded-lg hover:bg-red-600 hover:text-white transition text-[9px] font-bold uppercase ml-auto active:scale-95">
                                            <i data-lucide="play-circle" class="w-3 h-3"></i> Demo
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center justify-between bg-black/40 p-2 rounded-xl mb-4 border border-white/5">
                                <div class="pl-2 text-[10px] text-slate-500 font-mono uppercase tracking-wider">
                                    Last: <span x-text="getHistory(ex.name)" class="text-slate-300"></span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button class="stepper-btn text-slate-400 hover:bg-white/10" @click="stepWeight(ex.name, -1.25)">-</button>
                                    <div class="font-mono font-bold text-white text-xl w-20 text-center tabular-nums" x-text="getSavedWeight(ex.name) + 'kg'"></div>
                                    <button class="stepper-btn text-white bg-blue-600/50 border border-blue-500/50 hover:bg-blue-500" @click="stepWeight(ex.name, 1.25)">+</button>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-3 justify-center">
                                <template x-for="set in getSetsForWeek(ex)">
                                    <button @click="toggleSet(selectedDay, index, set, ex.rest)"
                                        class="w-12 h-10 rounded-xl border border-slate-700 flex items-center justify-center font-bold text-sm set-btn bg-slate-800/50 text-slate-500 font-mono"
                                        :class="isSetDone(selectedDay, index, set) ? 'done' : ''">
                                        <span x-text="set"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <button @click="finishWorkout()" class="w-full py-5 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl text-white font-logo text-lg uppercase tracking-widest shadow-xl shadow-blue-900/40 mb-10 border-t border-white/20 active:scale-95 transition">
                    Terminer Mission
                </button>
            </div>
        </div>

        <div x-show="activeWeightModal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak>
            <div class="glass-panel border border-white/10 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl max-h-[80vh] flex flex-col" @click.away="activeWeightModal = false">
                <button @click="activeWeightModal = false" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <h3 class="text-xl font-logo text-white mb-4 text-center">Historique Poids</h3>
                <div class="flex gap-2 mb-6">
                    <input type="number" x-model="manualWeight" placeholder="104.2" class="flex-1 bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-white font-bold outline-none focus:border-blue-500">
                    <button @click="logManualWeight()" class="bg-blue-600 text-white px-4 rounded-xl font-bold hover:bg-blue-500 active:scale-95 transition">OK</button>
                </div>
                <div class="h-40 w-full mb-4 bg-slate-900/50 rounded-xl p-2 border border-white/5">
                    <canvas id="weightHistoryChart"></canvas>
                </div>
                <div class="flex-1 overflow-y-auto space-y-2">
                    <template x-for="log in weightHistory.slice().reverse()">
                        <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg text-xs border border-white/5">
                            <span class="text-slate-400" x-text="log.date"></span>
                            <span class="text-white font-bold font-mono" x-text="log.weight + ' kg'"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div x-show="activeNutri" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeNutri = false">
             <div class="glass-panel border border-green-500/30 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl">
                <button @click="activeNutri = false" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center mx-auto mb-3 border border-green-500/20"><i :data-lucide="isHighCarb() ? 'zap' : 'leaf'" class="w-8 h-8 text-green-400"></i></div>
                    <h3 class="text-2xl font-logo text-white mb-1" :class="isHighCarb() ? 'text-green-400' : 'text-yellow-400'" x-text="isHighCarb() ? 'HIGH CARB DAY' : 'LOW CARB DAY'"></h3>
                </div>
                <div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 mb-4">
                    <h4 class="text-[10px] font-bold text-slate-300 uppercase mb-2">Pourquoi ce cycle ?</h4>
                    <p class="text-sm text-slate-300 leading-relaxed text-justify" x-text="getNutritionExplanation()"></p>
                </div>
            </div>
        </div>

        <div x-show="activeCardio" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeCardio = false">
            <div class="glass-panel border border-orange-500/30 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl">
                <button @click="activeCardio = false" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <div class="text-center mb-6">
                    <div class="w-14 h-14 rounded-full bg-orange-500/10 flex items-center justify-center mx-auto mb-3 border border-orange-500/20"><i data-lucide="flame" class="w-7 h-7 text-orange-500"></i></div>
                    <h3 class="text-2xl font-logo text-white mb-1">Semaine <span x-text="currentWeek"></span></h3>
                    <span class="text-[10px] bg-orange-500/20 text-orange-300 px-3 py-1 rounded-full border border-orange-500/30 font-mono uppercase tracking-wider" x-text="getCardioData().focus"></span>
                </div>
                <div class="space-y-4">
                    <div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Détails de la séance</h4>
                        <div class="text-sm text-white font-mono leading-relaxed" x-html="getCardioData().details"></div>
                    </div>
                    <div class="bg-orange-900/10 p-4 rounded-2xl border border-orange-500/20">
                        <h4 class="text-[10px] font-bold text-orange-400 uppercase mb-2 flex items-center gap-2"><i data-lucide="microscope" class="w-3 h-3"></i> Science</h4>
                        <p class="text-sm text-slate-200 leading-relaxed text-justify" x-text="getCardioData().science"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div x-show="activeExercise !== null" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeExercise = null">
            <div class="glass-panel border border-blue-500/30 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl">
                <button @click="activeExercise = null" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-logo text-white mb-2 leading-tight" x-text="activeExercise?.name"></h3>
                    <span class="text-[10px] bg-blue-500/20 text-blue-300 px-3 py-1 rounded-full border border-blue-500/30 font-mono uppercase tracking-wider" x-text="'Tempo: ' + activeExercise?.tempo"></span>
                </div>
                <div class="bg-blue-900/10 p-5 rounded-2xl border border-blue-500/20 max-h-[50vh] overflow-y-auto">
                    <h4 class="text-[10px] font-bold text-blue-400 uppercase mb-2 flex items-center gap-2"><i data-lucide="microscope" class="w-3 h-3"></i> Analyse Biomécanique</h4>
                    <p class="text-sm text-slate-200 leading-relaxed text-justify font-medium" x-text="activeExercise?.why"></p>
                </div>
            </div>
        </div>

        <div x-show="activeSupp !== null" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeSupp = null">
            <div class="glass-panel border border-white/10 rounded-3xl p-6 w-full max-w-sm relative overflow-hidden shadow-2xl">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r" :class="supplementsInfo[activeSupp]?.gradient"></div>
                <button @click="activeSupp = null" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <div class="text-center mb-6 mt-2">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mb-4 mx-auto border-2 shadow-[0_0_20px_rgba(255,255,255,0.1)]" :class="supplementsInfo[activeSupp]?.color + ' ' + supplementsInfo[activeSupp]?.bg + ' border-white/10'">
                        <i :data-lucide="supplementsInfo[activeSupp]?.icon" class="w-8 h-8"></i>
                    </div>
                    <h3 class="text-2xl font-logo text-white mb-1" x-text="supplementsInfo[activeSupp]?.title"></h3>
                </div>
                <div class="space-y-4">
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Mécanisme d'action</h4>
                        <p class="text-sm text-slate-200 leading-relaxed text-justify" x-text="supplementsInfo[activeSupp]?.text"></p>
                    </div>
                    <div class="flex items-center gap-3 bg-slate-900/50 p-3 rounded-xl border border-white/5">
                        <i data-lucide="clock" class="w-5 h-5 text-slate-400"></i>
                        <div><span class="text-[10px] font-bold text-slate-500 uppercase block">Protocole</span><span class="text-xs text-white font-mono font-bold" x-text="supplementsInfo[activeSupp]?.dose"></span></div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="tab === 'settings'" class="space-y-4">
             <div class="glass-panel p-5 rounded-2xl border border-green-500/30 flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400"><i data-lucide="cloud-lightning" class="w-5 h-5"></i></div>
                <div><h2 class="font-bold text-white text-sm font-tech uppercase">Synchronisation Active</h2><p class="text-xs text-slate-400 mt-1">Vos données sont sauvegardées en temps réel.</p></div>
             </div>
             <button @click="resetAll()" class="w-full py-4 text-red-500 text-xs border border-red-900/30 rounded-xl bg-red-900/10 font-bold uppercase hover:bg-red-900/20 transition active:scale-95">Reset Factory Data</button>
        </div>

    </main>

    <div x-show="timer.active" class="fixed bottom-0 inset-x-0 bg-[#020617] border-t border-blue-500/50 p-6 pb-8 z-50 rounded-t-[2.5rem] shadow-[0_-10px_60px_rgba(0,0,0,1)]" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-y-full">
        <div class="flex justify-between items-center mb-4 px-2">
            <span class="text-blue-400 text-xs font-bold uppercase animate-pulse font-tech tracking-widest">Récupération</span>
            <button @click="stopTimer()" class="text-slate-500 hover:text-white p-2"><i data-lucide="x-circle" class="w-6 h-6"></i></button>
        </div>
        <div class="text-center relative my-2">
            <span class="text-7xl font-logo font-bold text-white tabular-nums tracking-tighter drop-shadow-2xl" x-text="timer.current"></span>
            <span class="text-sm text-slate-500 absolute top-4 right-12 font-bold">SEC</span>
        </div>
        <div class="h-2 bg-slate-800 mt-6 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-1000 ease-linear" :style="`width: ${(timer.current/timer.total)*100}%`"></div>
        </div>
    </div>

    <div x-show="!timer.active" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-40">
        <div class="glass-panel rounded-full px-8 py-4 flex items-center gap-10 shadow-2xl border border-white/10 bg-black/60 backdrop-blur-xl ring-1 ring-white/5">
            <button @click="tab = 'home'" :class="tab==='home'?'text-blue-400 scale-125 drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]':'text-slate-500 hover:text-slate-300'" class="transition duration-300"><i data-lucide="layout-grid" class="w-6 h-6"></i></button>
            <button @click="startWorkoutSession()" class="relative -top-8 group">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-tr from-blue-700 to-blue-500 flex items-center justify-center shadow-[0_0_30px_rgba(37,99,235,0.6)] border-2 border-white/10 text-white transform transition duration-300 group-active:scale-90 rotate-45 group-hover:rotate-0 group-hover:scale-110">
                    <i data-lucide="dumbbell" class="w-8 h-8 -rotate-45 group-hover:rotate-0 transition duration-300"></i>
                </div>
            </button>
            <button @click="tab = 'settings'" :class="tab==='settings'?'text-blue-400 scale-125 drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]':'text-slate-500 hover:text-slate-300'" class="transition duration-300"><i data-lucide="settings" class="w-6 h-6"></i></button>
        </div>
    </div>

    <script>
        let db = null; 

        function app() {
            return {
                tab: 'home',
                currentWeight: 105.0, 
                currentWeek: 1,
                selectedDay: 'Lundi',
                syncStatus: 'connecting...',
                activeSupp: null,
                activeExercise: null,
                activeCardio: false,
                activeNutri: false,
                activeWeightModal: false,
                manualWeight: '',
                randomFact: { text: "Loading...", source: "" },
                macros: { protein: 0, fats: 0, carbsHigh: 0, carbsLow: 0, calories: 0 },

                firebaseConfig: {
                    apiKey: "AIzaSyCq4XRnYXwonhApbKhOztpe7PeaoJGl0xo",
                    authDomain: "superman-app-a07e1.firebaseapp.com",
                    projectId: "superman-app-a07e1",
                    storageBucket: "superman-app-a07e1.firebasestorage.app",
                    messagingSenderId: "434433392892",
                    appId: "1:434433392892:web:0fc4f95f6cce07c70a5779",
                    measurementId: "G-RMYFCRZ9GY"
                },

                xp: 0,
                streak: 1,
                weightHistory: [],
                completedSets: {},
                history: {},
                daily: { habits: { sleep: false, water: false, creatine: false, steps: false }, cardioDone: false },
                timer: { active: false, current: 0, total: 0, interval: null },
                chartInstance: null,
                historyChartInstance: null,
                
                // --- NATIVE YOUTUBE LINK ---
                openYoutube(query) {
                    const q = encodeURIComponent('technique execution ' + query);
                    const appUrl = `vnd.youtube://results?search_query=${q}`;
                    const webUrl = `https://www.youtube.com/results?search_query=${q}`;
                    
                    // Try to open app, fallback to new tab
                    window.location.href = appUrl;
                    setTimeout(() => {
                        window.open(webUrl, '_blank');
                    }, 500);
                },

                // --- MASSIVE FACTS DB (50+ items) ---
                factsDatabase: [
                    { text: "Le déficit calorique de 1375kcal est un stress majeur. Le sommeil < 7h augmente le cortisol, qui bloque littéralement la perte de gras abdominale.", source: "PubMed ID: 20921542" },
                    { text: "L'effet 'Whoosh' : Parfois le poids stagne 5 jours car les cellules graisseuses vidées se remplissent d'eau. Puis, soudainement, -1.5kg en une nuit. Patience.", source: "Physiologie Lyle McDonald" },
                    { text: "Les protéines à 2.5g/kg ne servent pas à construire du muscle ici, mais à survivre. Sans ça, ton corps 'mangerait' tes muscles pour l'énergie.", source: "J. Int. Soc. Sports Nutr" },
                    { text: "La marche (NEAT) est supérieure au cardio intense pour sécher car elle ne déclenche pas de pic d'appétit compensatoire ni de fatigue nerveuse.", source: "BioLayne Research" },
                    { text: "Le muscle est le tissu le plus 'cher' à entretenir. Plus tu en as, plus ton métabolisme de base est élevé, même en dormant.", source: "Basal Metabolic Rate" },
                    { text: "La discipline mange la motivation au petit-déjeuner. Tu ne seras pas toujours motivé, mais tu dois toujours être discipliné.", source: "Jocko Willink" },
                    { text: "L'échec musculaire réel recrute les fibres à haut seuil d'activation. Ce sont les seules qui ont un potentiel de croissance significatif.", source: "Henneman's Principle" },
                    { text: "Le corps change quand il est forcé de s'adapter. Si ta séance était facile, elle était inutile pour la transformation.", source: "Dorian Yates" },
                    { text: "Le froid active la graisse brune, qui brûle des calories pour produire de la chaleur. Termine ta douche par 30s d'eau froide.", source: "Huberman Lab" },
                    { text: "La leucine est l'acide aminé 'déclencheur' de la synthèse protéique. C'est pour ça que la Whey (riche en leucine) est imbattable post-training.", source: "Biochimie Sportive" },
                    { text: "Le cortisol est l'ennemi de la testostérone. Plus tu stresses, moins tu perds de gras. Respire.", source: "Endocrinologie" },
                    { text: "Un repas riche en glucides le soir aide à dormir en favorisant la production de sérotonine, précurseur de la mélatonine.", source: "Chronobiologie" },
                    { text: "L'insuline bloque la lipolyse. C'est pour ça qu'on garde les glucides autour de l'entraînement : pour les utiliser, pas les stocker.", source: "Insulin Mechanics" },
                    { text: "La congestion (le pump) n'est pas la croissance, mais elle étire le fascia musculaire et apporte des nutriments. C'est un signal positif.", source: "Arnold Schwarzenegger" },
                    { text: "La surcharge progressive ne veut pas dire 'plus lourd' à chaque fois. Ça peut être une rep de plus, ou un repos plus court.", source: "Training Principles" },
                    { text: "L'alcool arrête la combustion des graisses pendant 24h à 48h. C'est une pause complète dans ta progression.", source: "Toxicologie" },
                    { text: "La caféine avant l'entraînement augmente l'oxydation des graisses et réduit la perception de l'effort. L'outil ultime.", source: "JISSN" },
                    { text: "Le manque d'eau réduit la force de 10%. Une cellule musculaire déshydratée est une cellule catabolique.", source: "Hydration Science" },
                    { text: "Le sourire forcé entre les séries réduit le rythme cardiaque et le stress perçu. Hack ton cerveau.", source: "Psychologie Sportive" },
                    { text: "Tu ne peux pas compenser une mauvaise diet par le sport. 1h de cardio = 1 muffin. Ne joue pas à ça.", source: "Mathématiques" },
                    { text: "La douleur de la discipline pèse des grammes. La douleur du regret pèse des tonnes.", source: "Jim Rohn" },
                    { text: "On ne devient pas ce qu'on veut, on devient ce qu'on fait chaque jour.", source: "Aristote" },
                    { text: "Si c'était facile, tout le monde le ferait. La difficulté est ce qui rend la réussite grande.", source: "Tom Hanks" },
                    { text: "Ton corps peut supporter presque tout. C'est ton esprit que tu dois convaincre.", source: "David Goggins" },
                    { text: "Chaque rep est un vote pour la personne que tu veux devenir.", source: "James Clear" },
                    { text: "Le succès est la somme de petits efforts, répétés jour après jour.", source: "Robert Collier" },
                    { text: "Ne t'arrête pas quand tu es fatigué. Arrête-toi quand tu as fini.", source: "Navy SEALs" },
                    { text: "La seule mauvaise séance est celle que tu n'as pas faite.", source: "Sagesse Populaire" },
                    { text: "La motivation te fait démarrer. L'habitude te fait continuer.", source: "Jim Ryun" },
                    { text: "Il n'y a pas de raccourci. Il faut soulever des trucs lourds.", source: "Ronnie Coleman" }
                ],
                
                supplementsInfo: {
                    creatine: { 
                        short: "Créatine", icon: "zap", title: "Créatine Monohydrate", dose: "5g / jour (Sans cycle)",
                        text: "La créatine est le supplément le plus étudié au monde. Elle sature tes réserves de phosphocréatine (PCr) dans le muscle. Cela permet de régénérer l'ATP (énergie explosive) ultra-rapidement entre les séries. Résultat prouvé : +15% de force et de volume. Elle provoque aussi une rétention d'eau INTRA-cellulaire, ce qui est positif : le muscle est mieux hydraté et plus anabolique.",
                        color: "text-purple-400", bg: "bg-purple-500/10", gradient: "from-purple-500 to-indigo-500"
                    },
                    omega3: { 
                        short: "Omega 3", icon: "fish", title: "Omega 3 (EPA/DHA)", dose: "2-3g / jour (repas gras)",
                        text: "Indispensable en déficit calorique. Les Oméga-3 augmentent la fluidité des membranes cellulaires, ce qui améliore la sensibilité à l'insuline : tes nutriments vont dans le muscle plutôt que dans le gras. Ils réduisent aussi l'inflammation systémique (CRP) causée par l'entraînement intensif, protégeant tes tendons et articulations.",
                        color: "text-yellow-400", bg: "bg-yellow-500/10", gradient: "from-yellow-400 to-orange-500"
                    },
                    magnesium: { 
                        short: "Magnésium", icon: "moon", title: "Magnésium Bisglycinate", dose: "300-400mg (30min avant lit)",
                        text: "Le 'Valium de la nature'. L'entraînement lourd taxe le système nerveux sympathique (fight or flight). Le magnésium active le système parasympathique (rest & digest). Il est crucial pour un sommeil profond réparateur, moment où 95% de l'hormone de croissance est sécrétée pour brûler le gras.",
                        color: "text-blue-400", bg: "bg-blue-500/10", gradient: "from-blue-400 to-cyan-500"
                    },
                    protein: { 
                        short: "Whey", icon: "milk", title: "Whey Isolate", dose: "40g Post-training",
                        text: "L'outil chirurgical de la récupération. L'Isolate est filtrée pour ne garder que la protéine pure, sans lactose ni graisse. Sa vitesse d'absorption est son atout : elle inonde le sang d'acides aminés (Leucine) en moins de 30min, stoppant net le catabolisme musculaire post-séance.",
                        color: "text-slate-200", bg: "bg-slate-700/30", gradient: "from-slate-400 to-slate-600"
                    }
                },

                splitOrder: ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'],
                exercises: {
                    'Lundi': [ 
                        { name: "Dev. Couché Haltères", target: "PECS", tempo: "3-1-1-0", baseSets: 4, reps: "6-8", rest: 120, why: "L'amplitude des haltères est supérieure à la barre, étirant les fibres pectorales sous charge maximale. C'est le facteur mécanique n°1 de l'hypertrophie." },
                        { name: "Dev. Incliné Machine", target: "HAUT PECS", tempo: "3-0-1-1", baseSets: 3, reps: "10-12", rest: 90, why: "Cible la portion claviculaire (le 'shelf' du haut des pecs). La machine permet d'aller à l'échec total sans risque de se faire écraser." },
                        { name: "Dev. Militaire Haltères", target: "ÉPAULES", tempo: "3-0-1-0", baseSets: 3, reps: "8-10", rest: 90, why: "Masse globale des deltoïdes. Le dossier protège les lombaires pour que toute l'énergie aille dans les épaules." },
                        { name: "Élévations Latérales", target: "LARGEUR", tempo: "2-0-1-1", baseSets: 5, reps: "15-20", rest: 45, why: "Le secret de la carrure en V. Le volume élevé (5 sets) est nécessaire car ce petit muscle récupère vite." },
                        { name: "Extensions Triceps Corde", target: "TRICEPS", tempo: "3-0-1-1", baseSets: 4, reps: "12-15", rest: 60, why: "Isole la longue portion du triceps. Écarter la corde en bas permet une contraction de pic maximale." }
                    ],
                    'Mardi': [ 
                        { name: "Tractions (ou Assistées)", target: "DOS LARGEUR", tempo: "3-0-1-0", baseSets: 4, reps: "8-10", rest: 120, why: "Le mouvement roi pour élargir le dos. Il mobilise le plus de masse musculaire du haut du corps." },
                        { name: "Rowing Buste Penché", target: "DOS ÉPAISSEUR", tempo: "3-1-X-0", baseSets: 4, reps: "8-10", rest: 120, why: "Donne la densité et le relief du dos. La phase excentrique contrôlée est cruciale pour ne pas se blesser." },
                        { name: "Tirage Vertical Neutre", target: "DORSAL", tempo: "3-0-1-1", baseSets: 3, reps: "10-12", rest: 90, why: "La prise neutre place le grand dorsal dans sa ligne de force optimale pour une contraction complète." },
                        { name: "Face Pull", target: "POSTURE", tempo: "2-1-1-1", baseSets: 4, reps: "15-20", rest: 60, why: "Santé de l'épaule et développement des trapèzes/deltoïdes postérieurs. Indispensable pour la posture." },
                        { name: "Curl Barre EZ", target: "BICEPS", tempo: "3-0-1-0", baseSets: 4, reps: "8-10", rest: 90, why: "Masse brute des biceps. La barre EZ soulage les poignets par rapport à une barre droite." }
                    ],
                    'Mercredi': [ 
                        { name: "Wrist Curl Barre", target: "AVANT-BRAS", tempo: "2-0-1-0", baseSets: 4, reps: "15-20", rest: 45, isPopeye: true, why: "Hypertrophie des fléchisseurs. Laissez la barre rouler jusqu'au bout des doigts." },
                        { name: "Wrist Curl Haltère", target: "AVANT-BRAS", tempo: "2-0-1-0", baseSets: 3, reps: "15-20", rest: 30, isPopeye: true, why: "Travail unilatéral pour corriger les déséquilibres de force." },
                        { name: "Reverse Curl EZ", target: "BRACHIAL", tempo: "3-0-1-0", baseSets: 4, reps: "12-15", rest: 60, isPopeye: true, why: "Cible le brachial (sous le biceps) et le brachioradial (dessus de l'avant-bras)." },
                        { name: "Reverse Wrist Curl", target: "EXTENSEURS", tempo: "2-0-1-0", baseSets: 4, reps: "15-20", rest: 45, isPopeye: true, why: "Développement des extenseurs pour un avant-bras complet et équilibré." },
                        { name: "Marche du Fermier", target: "GRIP", tempo: "Static", baseSets: 4, reps: "45-60s", rest: 90, isPopeye: true, why: "Force fonctionnelle pure. Développe le grip, les trapèzes et le gainage." },
                        { name: "Dead Hang", target: "GRIP", tempo: "Static", baseSets: 4, reps: "Max", rest: 60, isPopeye: true, why: "Décompression vertébrale massive (Scoliose Friendly) et endurance de grip." }
                    ],
                    'Jeudi': [ 
                        { name: "Squat (ou Hack)", target: "CUISSES", tempo: "3-1-X-0", baseSets: 4, reps: "6-8", rest: 180, why: "Le bâtisseur de jambes ultime. Tension mécanique maximale sur les quadriceps et fessiers." },
                        { name: "Fentes Bulgares", target: "FESSIERS", tempo: "3-0-1-0", baseSets: 3, reps: "10", rest: 120, why: "L'exercice le plus efficace pour les fessiers et la stabilité. Difficile mais payant." },
                        { name: "Leg Extension", target: "QUADS", tempo: "2-0-1-1", baseSets: 4, reps: "15-20", rest: 60, why: "Isolation sans risque pour finir les quadriceps. Brûlure garantie." },
                        { name: "Leg Curl Allongé", target: "ISCHIOS", tempo: "3-0-1-0", baseSets: 4, reps: "10-12", rest: 90, why: "Essentiel pour l'équilibre du genou et l'esthétique de la cuisse de profil." },
                        { name: "Mollets Debout", target: "MOLLETS", tempo: "3-1-1-1", baseSets: 5, reps: "15-20", rest: 45, why: "Pause en bas obligatoire pour désactiver le tendon d'Achille et cibler le muscle." }
                    ],
                    'Vendredi': [ 
                        { name: "Dips (Lestés)", target: "PECS/TRI", tempo: "3-0-1-0", baseSets: 4, reps: "10", rest: 90, why: "Le squat du haut du corps. Recrute pecs, deltoïdes et triceps massivement." },
                        { name: "Tirage Horizontal", target: "DOS", tempo: "3-0-1-1", baseSets: 4, reps: "10-12", rest: 90, why: "Travaille l'épaisseur du milieu du dos. Cherchez à toucher vos omoplates." },
                        { name: "Élévations Latérales", target: "ÉPAULES", tempo: "2-0-1-1", baseSets: 4, reps: "15", rest: 45, why: "Rappel volume indispensable pour la largeur d'épaules." },
                        { name: "Curl Marteau", target: "BICEPS", tempo: "3-0-1-0", baseSets: 4, reps: "12", rest: 60, why: "Donne de l'épaisseur au bras vu de face (Brachial)." },
                        { name: "Gainage Planche", target: "ABS", tempo: "Static", baseSets: 4, reps: "Max", rest: 60, why: "Renforcement du transverse pour un ventre plat et une colonne protégée." }
                    ]
                },

                async initApp() {
                    lucide.createIcons();
                    this.loadLocal();
                    this.selectedDay = this.getTodayName();
                    this.generateFact();
                    this.calculateMacros(); 
                    this.connectFirebase();
                    setTimeout(() => this.renderChart(), 200);
                },

                connectFirebase() {
                    try {
                        if (!firebase.apps.length) {
                            firebase.initializeApp(this.firebaseConfig);
                            db = firebase.firestore();
                            this.syncStatus = 'online';
                            this.listenToCloud();
                        }
                    } catch (e) {
                        console.error(e);
                        this.syncStatus = 'error';
                    }
                },

                listenToCloud() {
                    db.collection('users').doc('superman_user').onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            this.currentWeight = data.currentWeight || this.currentWeight;
                            this.currentWeek = data.currentWeek || 1;
                            this.xp = data.xp || this.xp;
                            this.streak = data.streak || this.streak;
                            this.completedSets = data.completedSets || {};
                            this.history = data.history || {};
                            this.weightHistory = data.weightHistory || [];
                            if (data.daily) {
                                this.daily.cardioDone = data.daily.cardioDone;
                            }
                            this.calculateMacros(); 
                            this.renderChart();
                        }
                    });
                },

                pushToCloud() {
                    if (db) {
                        db.collection('users').doc('superman_user').set({
                            currentWeight: this.currentWeight,
                            currentWeek: this.currentWeek,
                            xp: this.xp,
                            streak: this.streak,
                            completedSets: this.completedSets,
                            history: this.history,
                            weightHistory: this.weightHistory,
                            daily: this.daily,
                            lastUpdate: new Date().toISOString()
                        }, { merge: true });
                    }
                    this.saveLocal();
                    this.calculateMacros(); 
                },

                loadLocal() {
                    const d = JSON.parse(localStorage.getItem('superman_v27'));
                    if(d) {
                        this.currentWeight = d.currentWeight;
                        this.currentWeek = d.currentWeek || 1;
                        this.xp = d.xp;
                        this.streak = d.streak || 1;
                        this.weightHistory = d.weightHistory || [];
                        this.history = d.history || {};
                        if (d.daily) { this.daily = d.daily; }
                    }
                },
                saveLocal() {
                    localStorage.setItem('superman_v27', JSON.stringify({
                        currentWeight: this.currentWeight,
                        currentWeek: this.currentWeek,
                        xp: this.xp,
                        streak: this.streak,
                        weightHistory: this.weightHistory,
                        history: this.history,
                        daily: this.daily
                    }));
                },

                toggleCardio() {
                    this.daily.cardioDone = !this.daily.cardioDone;
                    if (this.daily.cardioDone) {
                        this.xp += 50;
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#f97316', '#fbbf24'] });
                    } else {
                        this.xp -= 50;
                    }
                    this.pushToCloud();
                },

                openSupp(key) { this.activeSupp = key; },
                openExerciseInfo(ex) { this.activeExercise = ex; },
                openCardioInfo() { this.activeCardio = true; },
                
                openWeightHistory() {
                    this.activeWeightModal = true;
                    setTimeout(() => this.renderHistoryChart(), 200);
                },
                logManualWeight() {
                    if(this.manualWeight) {
                        const val = parseFloat(this.manualWeight);
                        this.currentWeight = val;
                        this.weightHistory.push({date: new Date().toLocaleDateString(), weight: val});
                        this.pushToCloud();
                        this.manualWeight = '';
                        this.renderHistoryChart(); 
                        this.renderChart(); 
                    }
                },

                generateFact() { this.randomFact = this.factsDatabase[Math.floor(Math.random() * this.factsDatabase.length)]; },

                calculateMacros() {
                    const totalCalories = Math.round(this.currentWeight * 20); 
                    const protein = Math.round(this.currentWeight * 2.5);
                    const fats = Math.round(this.currentWeight * 0.55); 
                    const calsFromProtFat = (protein * 4) + (fats * 9);
                    const remainingCals = totalCalories - calsFromProtFat;
                    const carbsHigh = Math.max(0, Math.round(remainingCals / 4));
                    const carbsLow = Math.max(0, Math.round((remainingCals * 0.7) / 4));
                    
                    this.macros = { protein: protein, fats: fats, carbsHigh: carbsHigh, carbsLow: carbsLow, calories: totalCalories };
                },
                
                getNutritionExplanation() {
                    if(this.isHighCarb()) {
                        return "Aujourd'hui, c'est une journée 'LOURDE' (Dos, Jambes). Ton corps va puiser massivement dans ses réserves de glycogène. Nous augmentons les glucides pour : 1. Fournir l'énergie explosive. 2. Réduire le cortisol (catabolisme) post-séance. 3. Stimuler la leptine pour garder le métabolisme haut.";
                    } else {
                        return "Aujourd'hui est une journée 'LÉGÈRE' (Bras, Repos). La dépense énergétique est moindre. Nous réduisons les glucides pour forcer ton corps à changer de carburant et brûler les graisses (Lipolyse) tout en améliorant ta sensibilité à l'insuline.";
                    }
                },

                changeWeek(delta) {
                    let next = this.currentWeek + delta;
                    if(next < 1) next = 1; if(next > 16) next = 16;
                    this.currentWeek = next; this.pushToCloud();
                },
                getSetsForWeek(ex) {
                    let sets = ex.baseSets;
                    if (this.currentWeek >= 5 && this.currentWeek <= 8) sets += 1;
                    if (this.currentWeek >= 9 && this.currentWeek <= 12) sets += 2;
                    if (this.currentWeek >= 13) sets += 1;
                    return sets;
                },
                updateWeight(delta) {
                    this.currentWeight = Math.round((this.currentWeight + delta) * 100) / 100;
                    this.weightHistory.push({date: new Date().toLocaleDateString(), weight: this.currentWeight});
                    this.pushToCloud();
                    this.renderChart();
                },
                stepWeight(exName, delta) {
                    let current = parseFloat(this.history[exName] || 0);
                    let newVal = Math.round((current + delta) * 100) / 100;
                    if(newVal < 0) newVal = 0;
                    this.history[exName] = newVal;
                    this.pushToCloud();
                },
                getSavedWeight(name) { return this.history[name] || 0; },
                getHistory(name) { return this.history[name] ? this.history[name] + 'kg' : '-'; },
                
                getTodayName() {
                    const d = new Date().getDay();
                    const map = {1:'Lundi', 2:'Mardi', 3:'Mercredi', 4:'Jeudi', 5:'Vendredi', 6:'Samedi', 0:'Dimanche'};
                    return map[d] || 'Lundi';
                },
                isHighCarb() { return ['Mardi', 'Jeudi'].includes(this.selectedDay); },
                
                get currentPhase() {
                    if(this.currentWeek <= 4) return "1 (Adapt)";
                    if(this.currentWeek <= 8) return "2 (Intense)";
                    if(this.currentWeek <= 12) return "3 (MAX)";
                    return "4 (CUT)";
                },

                getCardioData() {
                    const w = this.currentWeek;
                    if (w <= 2) return { 
                        focus: "ACTIVATION (S1-2)", 
                        summary: "35min • 4.5km/h • 5%", 
                        details: "<ul class='list-disc pl-4 space-y-2'><li><b>Matin (Jeun):</b> 35min marche rapide.</li><li><b>Paramètres:</b> 4.5 km/h @ 5% inclinaison.</li><li><b>Soir:</b> 35min marche digestive.</li></ul>",
                        science: "Réveil de la lipolyse en douceur. La marche à jeun mobilise les acides gras libres quand l'insuline est basse."
                    };
                    if (w <= 4) return { 
                        focus: "STABILISATION (S3-4)", 
                        summary: "40min • 5.0km/h • 7%", 
                        details: "<ul class='list-disc pl-4 space-y-2'><li><b>Matin:</b> 40min.</li><li><b>Paramètres:</b> 5.0 km/h @ 7%.</li><li><b>Soir:</b> 40min marche active.</li></ul>",
                        science: "On augmente la charge de travail pour forcer l'adaptation mitochondriale (les usines à énergie de tes cellules)."
                    };
                    if (w <= 6) return { 
                        focus: "INTERVALLES (S5-6)", 
                        summary: "Intervalles 6x (1min/2min)", 
                        details: "<ul class='list-disc pl-4 space-y-2'><li><b>Cycle (x6):</b> 1min @ 5.5km/h 8% / 2min @ 4.2km/h 2%.</li><li><b>Total:</b> ~35min.</li></ul>",
                        science: "L'alternance d'intensité crée une dette d'oxygène (EPOC) qui booste le métabolisme pendant des heures après la séance."
                    };
                    if (w <= 8) return { 
                        focus: "POWER INCLINE (S7-8)", 
                        summary: "45min • 4.5km/h • 10%", 
                        details: "<ul class='list-disc pl-4 space-y-2'><li><b>Matin:</b> 45min.</li><li><b>Paramètres:</b> 4.5 km/h @ 10% (Dur!).</li><li><b>Soir:</b> 35min cool.</li></ul>",
                        science: "10% de pente recrute massivement la chaîne postérieure (fessiers/ischios) sans impact articulaire, brûlant +50% de calories vs plat."
                    };
                    if (w <= 10) return { 
                        focus: "ENDURANCE HAUTE (S9-10)", 
                        summary: "30min • 5.5km/h • 12%", 
                        details: "<ul class='list-disc pl-4 space-y-2'><li><b>Matin:</b> 30min soutenu.</li><li><b>Paramètres:</b> 5.5 km/h @ 12%.</li><li><b>Soir:</b> 40min 5%.</li></ul>",
                        science: "On attaque la graisse viscérale résistante en maintenant une fréquence cardiaque élevée constante (Zone 2-3)."
                    };
                    if (w <= 12) return { 
                        focus: "SUPERMAN INTERVALS (S11-12)", 
                        summary: "Intervalles 8x (2min/2min)", 
                        details: "<ul class='list-disc pl-4 space-y-2'><li><b>Cycle (x8):</b> 2min @ 6km/h 12% / 2min @ 4.5km/h 3%.</li><li><b>Total:</b> ~45min.</li></ul>",
                        science: "Pic d'intensité. Ce protocole vide les dernières réserves de glycogène pour une perte de gras maximale."
                    };
                    if (w <= 14) return { 
                        focus: "PEAK BURN (S13-14)", 
                        summary: "45min • 5.2km/h • 10%", 
                        details: "<ul class='list-disc pl-4 space-y-2'><li><b>Matin:</b> 45min Steady.</li><li><b>Paramètres:</b> 5.2 km/h @ 10%.</li></ul>",
                        science: "Retour au steady state pour réduire le stress nerveux (cortisol) avant la fin, tout en gardant une dépense calorique massive."
                    };
                    return { 
                        focus: "FINAL CUT (S15-16)", 
                        summary: "50min • 5.0km/h • 8%", 
                        details: "<ul class='list-disc pl-4 space-y-2'><li><b>Matin:</b> 50min à jeun.</li><li><b>Soir:</b> 45min post-repas.</li></ul>",
                        science: "Volume maximal, intensité modérée. Objectif : drainer l'eau sous-cutanée et révéler la définition musculaire ultime."
                    };
                },

                startWorkoutSession() { 
                    this.tab = 'train'; 
                    const day = this.getTodayName();
                    this.selectedDay = (day === 'Samedi' || day === 'Dimanche') ? 'Lundi' : day;
                    document.getElementById('scroller').scrollTo(0,0);
                },
                getExercises(day) { return this.exercises[day] || []; },
                toggleSet(day, exIdx, set, rest) {
                    const k = `W${this.currentWeek}-${day}-${exIdx}-${set}`;
                    if(this.completedSets[k]) { delete this.completedSets[k]; this.xp -= 10; } 
                    else { this.completedSets[k] = true; this.xp += 20; this.startTimer(rest); if(navigator.vibrate) navigator.vibrate(50); }
                    this.pushToCloud();
                },
                finishWorkout() {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#3b82f6', '#ef4444'] });
                    this.xp += 100; 
                    this.streak += 1; // Increment Streak
                    this.pushToCloud(); 
                    alert("SÉANCE TERMINÉE ! +100 XP & STREAK +1 🔥"); 
                    this.tab = 'home';
                },
                startTimer(sec) {
                    if(this.timer.interval) clearInterval(this.timer.interval);
                    this.timer.total = sec; this.timer.current = sec; this.timer.active = true;
                    this.timer.interval = setInterval(() => {
                        this.timer.current--;
                        if(this.timer.current <= 0) { this.stopTimer(); if(navigator.vibrate) navigator.vibrate([200,100,200]); }
                    }, 1000);
                },
                stopTimer() { this.timer.active = false; clearInterval(this.timer.interval); },
                get xpProgress() { return (this.xp % 1000) / 10; },
                get userLevel() { return Math.floor(this.xp / 1000) + 1; },
                getRankName() { const l = this.userLevel; if(l < 5) return 'Recrue'; if(l < 10) return 'Soldat'; if(l < 15) return 'Commandant'; return 'Kryptonien'; },
                
                async resetAll() {
                    if(!confirm("ATTENTION: CELA EFFACERA TOUT (Cloud + Local). Continuer ?")) return;
                    this.xp = 0; this.streak = 1; this.currentWeek = 1; this.currentWeight = 105.0; this.weightHistory = []; this.history = {}; this.completedSets = {}; 
                    this.daily = { habits: { sleep: false, water: false, creatine: false, steps: false }, cardioDone: false };
                    if(db) {
                        await db.collection('users').doc('superman_user').set({
                            xp: 0, streak: 1, currentWeek: 1, currentWeight: 105.0, weightHistory: [], history: {}, completedSets: {}, daily: this.daily, lastUpdate: new Date().toISOString()
                        });
                    }
                    localStorage.clear(); setTimeout(() => location.reload(), 500);
                },

                renderChart() {
                    const ctx = document.getElementById('weightChart');
                    if(!ctx) return;
                    if(this.chartInstance) this.chartInstance.destroy();
                    const data = this.weightHistory.length ? this.weightHistory.map(x=>x.weight) : [105];
                    const labels = this.weightHistory.length ? this.weightHistory.map(x=>x.date) : ['Start'];
                    this.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: { labels: labels, datasets: [{ data: data, borderColor: '#3b82f6', borderWidth: 2, tension: 0.4, pointRadius: 2 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { x: {display: false}, y: {display: false} } }
                    });
                },
                
                renderHistoryChart() {
                    const ctx = document.getElementById('weightHistoryChart');
                    if(!ctx) return;
                    if(this.historyChartInstance) this.historyChartInstance.destroy();
                    const data = this.weightHistory.length ? this.weightHistory.map(x=>x.weight) : [105];
                    const labels = this.weightHistory.length ? this.weightHistory.map(x=>x.date) : ['Start'];
                    this.historyChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: { labels: labels, datasets: [{ label: 'Progression', data: data, borderColor: '#3b82f6', borderWidth: 3, backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { grid: { color: '#1e293b' } }, x: { grid: { display: false } } } }
                    });
                }
            }
        }
    </script>
</body>
</html>