<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROAD TO SUPERMAN | FINAL</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,400;0,700;1,700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .font-hero { font-family: 'Chakra Petch', sans-serif; }

        /* Dynamic Background */
        .bg-aurora {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle at 50% -20%, #172554 0%, #020617 60%);
        }
        .bg-aurora::after {
            content: ''; position: absolute; inset: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
            opacity: 0.3;
        }

        /* UI Elements */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        .stepper-btn {
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1); border-radius: 6px; font-weight: bold;
        }
        .stepper-btn:active { background: rgba(255,255,255,0.2); transform: scale(0.95); }

        .set-btn { transition: all 0.2s; }
        .set-btn.done {
            background: #2563eb; color: white; border-color: #2563eb;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.5);
        }

        /* Carb Cycle Badges */
        .carb-high { color: #4ade80; background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.2); }
        .carb-low { color: #facc15; background: rgba(250, 204, 21, 0.1); border: 1px solid rgba(250, 204, 21, 0.2); }

        .title-main {
            font-family: 'Chakra Petch', sans-serif; font-style: italic; font-weight: 800;
            text-align: center; font-size: 1.6rem; color: white; text-shadow: 0 0 20px rgba(37,99,235,0.8);
            margin-top: 10px; letter-spacing: 1px; text-transform: uppercase;
        }
    </style>
</head>
<body x-data="app()" x-init="initApp()" class="h-screen flex flex-col text-slate-200">

    <div class="bg-aurora"></div>
    
    <div class="absolute top-2 left-2 z-50 flex items-center gap-1" :class="syncStatus === 'online' ? 'text-green-500' : 'text-slate-600'">
        <div class="w-2 h-2 rounded-full" :class="syncStatus === 'online' ? 'bg-green-500 animate-pulse' : 'bg-red-500'"></div>
        <span class="text-[9px] font-mono uppercase" x-text="syncStatus === 'online' ? 'CLOUD SYNC' : 'OFFLINE'"></span>
    </div>

    <div class="title-main">ROAD TO SUPERMAN</div>

    <header class="flex-none px-4 pb-2 flex justify-between items-center z-20">
        <div class="flex items-center gap-3 w-full">
            <div class="relative flex-1">
                <div class="flex justify-between text-[10px] uppercase font-bold mb-1 text-blue-300">
                    <span>LVL <span x-text="userLevel"></span>: <span x-text="getRankName()"></span></span>
                    <span x-text="Math.floor(xp) + ' XP'"></span>
                </div>
                <div class="h-2 bg-slate-800 rounded-full overflow-hidden border border-white/5">
                    <div class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-1000" :style="`width: ${xpProgress}%`"></div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 pb-32 relative scroll-smooth" id="scroller">
        
        <div x-show="tab === 'home'" class="space-y-4">
            
            <div class="glass-panel rounded-2xl p-5 relative overflow-hidden">
                <div class="flex justify-between items-end relative z-10">
                    <div>
                        <p class="text-[10px] text-blue-400 font-bold uppercase tracking-wider">Objectif 85 KG</p>
                        <div class="flex items-baseline gap-1">
                            <span class="text-4xl font-hero font-bold text-white" x-text="currentWeight"></span>
                            <span class="text-sm text-slate-400">kg</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 bg-black/30 p-1 rounded-lg border border-white/10">
                        <button @click="updateWeight(-0.1)" class="w-8 h-8 flex items-center justify-center bg-slate-800 rounded text-white hover:bg-blue-600 transition">-</button>
                        <button @click="updateWeight(0.1)" class="w-8 h-8 flex items-center justify-center bg-slate-800 rounded text-white hover:bg-blue-600 transition">+</button>
                    </div>
                </div>
                <div class="h-24 w-full mt-4">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-4 flex items-center justify-between border-l-4" :class="isHighCarb() ? 'border-l-green-500' : 'border-l-yellow-500'">
                <div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Cycle Nutrition</div>
                    <div class="text-lg font-bold font-hero" :class="isHighCarb() ? 'text-green-400' : 'text-yellow-400'" x-text="isHighCarb() ? 'HIGH CARB DAY' : 'LOW CARB DAY'"></div>
                    <div class="text-[10px] text-slate-500 mt-0.5" x-text="isHighCarb() ? 'Riz, Pâtes, Avoine autorisés' : 'Légumes verts & Graisses saines'"></div>
                </div>
                <i :data-lucide="isHighCarb() ? 'zap' : 'leaf'" class="w-6 h-6 opacity-50"></i>
            </div>

            <button @click="startWorkoutSession()" class="w-full group relative">
                <div class="absolute inset-0 bg-blue-600 rounded-2xl blur opacity-20 group-hover:opacity-40 transition"></div>
                <div class="glass-panel p-4 rounded-2xl flex items-center gap-4 border border-blue-500/30 relative">
                    <div class="w-12 h-12 rounded-xl bg-blue-600 flex items-center justify-center text-white shadow-lg">
                        <i data-lucide="dumbbell" class="w-6 h-6"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <div class="text-[10px] text-blue-300 uppercase font-bold">Séance du jour</div>
                        <div class="text-xl font-hero font-bold text-white uppercase italic" x-text="selectedDay"></div>
                    </div>
                    <i data-lucide="chevron-right" class="text-slate-500"></i>
                </div>
            </button>
        </div>

        <div x-show="tab === 'train'" class="space-y-4">
            
            <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2">
                <template x-for="day in splitOrder">
                    <button @click="selectedDay = day" class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase border transition-all whitespace-nowrap"
                    :class="selectedDay === day ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-800/50 border-slate-700 text-slate-500'">
                        <span x-text="day"></span>
                    </button>
                </template>
            </div>

            <div class="space-y-3 pb-24">
                <template x-for="(ex, index) in getExercises(selectedDay)" :key="index">
                    <div class="glass-panel rounded-xl overflow-hidden border-l-2" :class="ex.isBonus ? 'border-l-yellow-500' : 'border-l-blue-500'">
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h4 class="font-bold text-white text-sm" x-text="ex.name"></h4>
                                    <p class="text-[10px] text-slate-400 italic mt-1" x-text="ex.note"></p>
                                </div>
                                <i x-show="ex.spineSafe" data-lucide="shield-check" class="w-4 h-4 text-green-500"></i>
                            </div>

                            <div class="flex items-center justify-between bg-black/30 p-2 rounded-lg mb-3 border border-white/5">
                                <div class="text-[9px] text-slate-500 font-mono uppercase">
                                    Last: <span x-text="getHistory(ex.name)"></span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button class="stepper-btn text-slate-400" @click="stepWeight(ex.name, -1.25)">-</button>
                                    <div class="font-mono font-bold text-white text-lg w-12 text-center" 
                                         :class="isPR(ex.name) ? 'text-green-400' : 'text-white'"
                                         x-text="getSavedWeight(ex.name) + 'kg'"></div>
                                    <button class="stepper-btn text-white bg-blue-600/50 border border-blue-500/50" @click="stepWeight(ex.name, 1.25)">+</button>
                                </div>
                            </div>

                            <div class="flex gap-3 justify-center">
                                <template x-for="set in ex.sets">
                                    <button @click="toggleSet(selectedDay, index, set, ex.rest)"
                                        class="w-10 h-10 rounded-lg border border-slate-700 flex items-center justify-center font-bold text-sm set-btn bg-slate-800/50 text-slate-500"
                                        :class="isSetDone(selectedDay, index, set) ? 'done' : ''">
                                        <span x-text="set"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="glass-panel p-4 rounded-xl border border-green-500/30 bg-green-900/10">
                    <div class="flex items-center gap-3 mb-2">
                        <i data-lucide="activity" class="text-green-400 w-5 h-5"></i>
                        <h3 class="font-bold text-green-400 text-sm uppercase">Hygiène Colone</h3>
                    </div>
                    <p class="text-xs text-slate-300">Suspendre à une barre (Dead Hang) pendant 60 secondes pour décompresser les disques.</p>
                    <button @click="startTimer(60)" class="mt-3 w-full py-2 bg-green-600/20 text-green-400 border border-green-600 rounded text-xs font-bold uppercase">Lancer Décompression</button>
                </div>

                <button @click="finishWorkout()" class="w-full py-4 bg-blue-600 rounded-xl text-white font-hero font-bold uppercase tracking-widest shadow-lg shadow-blue-900/50">
                    Terminer Mission
                </button>
            </div>
        </div>

        <div x-show="tab === 'settings'" class="space-y-4">
             <div class="glass-panel p-4 rounded-xl border border-green-500/30">
                <h2 class="font-bold text-white mb-2 text-green-400 flex items-center gap-2">
                    <i data-lucide="cloud-lightning" class="w-4 h-4"></i>
                    SYNC ACTIVÉE
                </h2>
                <p class="text-xs text-slate-400">Tes données sont synchronisées en temps réel avec le cloud.</p>
             </div>
             
             <div class="glass-panel p-4 rounded-xl opacity-50">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Config actuelle</h3>
                <div class="text-[9px] font-mono text-slate-600 break-all">
                    Project: superman-app-a07e1<br>
                    Status: <span x-text="syncStatus"></span>
                </div>
             </div>

             <button @click="resetAll()" class="w-full py-3 text-red-500 text-xs border border-red-900/30 rounded bg-red-900/10">Reset Local Data</button>
        </div>

    </main>

    <div x-show="timer.active" class="fixed bottom-0 inset-x-0 bg-slate-900 border-t border-blue-500/50 p-4 pb-6 z-50 rounded-t-2xl shadow-[0_-10px_50px_rgba(0,0,0,1)]">
        <div class="flex justify-between items-center mb-2">
            <span class="text-blue-400 text-xs font-bold uppercase animate-pulse">Repos en cours</span>
            <button @click="stopTimer()" class="text-slate-500"><i data-lucide="x-circle"></i></button>
        </div>
        <div class="text-center">
            <span class="text-5xl font-hero font-bold text-white tabular-nums" x-text="timer.current"></span>
        </div>
        <div class="h-1 bg-slate-800 mt-3 rounded-full overflow-hidden">
            <div class="h-full bg-blue-500 transition-all duration-1000 ease-linear" :style="`width: ${(timer.current/timer.total)*100}%`"></div>
        </div>
    </div>

    <div x-show="!timer.active" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-40">
        <div class="glass-panel rounded-full px-6 py-3 flex items-center gap-8 shadow-2xl">
            <button @click="tab = 'home'" :class="tab==='home'?'text-blue-400':'text-slate-500'"><i data-lucide="layout-grid" class="w-6 h-6"></i></button>
            <button @click="startWorkoutSession()" class="relative -top-5">
                <div class="w-14 h-14 rounded-full bg-blue-600 flex items-center justify-center shadow-lg border-4 border-[#020617] text-white">
                    <i data-lucide="dumbbell" class="w-6 h-6"></i>
                </div>
            </button>
            <button @click="tab = 'settings'" :class="tab==='settings'?'text-blue-400':'text-slate-500'"><i data-lucide="settings" class="w-6 h-6"></i></button>
        </div>
    </div>

    <script>
        let db = null; 

        function app() {
            return {
                tab: 'home',
                currentWeight: 105,
                selectedDay: 'Upper',
                syncStatus: 'connecting...',
                
                // Configuration Firebase "Baked In"
                firebaseConfig: {
                    apiKey: "AIzaSyCq4XRnYXwonhApbKhOztpe7PeaoJGl0xo",
                    authDomain: "superman-app-a07e1.firebaseapp.com",
                    projectId: "superman-app-a07e1",
                    storageBucket: "superman-app-a07e1.firebasestorage.app",
                    messagingSenderId: "434433392892",
                    appId: "1:434433392892:web:0fc4f95f6cce07c70a5779",
                    measurementId: "G-RMYFCRZ9GY"
                },

                // Gamification
                xp: 0,
                daily: { water: 0, creatine: false },
                
                // Data
                weightHistory: [],
                completedSets: {},
                history: {}, // Max weights
                
                timer: { active: false, current: 0, total: 0, interval: null },
                chartInstance: null,
                
                // --- DATA PROGRAMME ---
                splitOrder: ['Upper', 'Lower', 'Bras', 'Push', 'Pull', 'Legs'],
                exercises: {
                    'Upper': [
                        { name: "Dev. Couché Haltères", sets: 4, reps: "6-8", rest: 120, note: "Force Pectoraux", spineSafe: true },
                        { name: "Tirage Poitrine (Machine)", sets: 4, reps: "8-10", rest: 90, note: "Dos épaisseur", spineSafe: true },
                        { name: "Dev. Épaules Incliné 75°", sets: 3, reps: "10", rest: 90, note: "Plus safe que le militaire", spineSafe: true },
                        { name: "Tractions Assistées", sets: 3, reps: "Max", rest: 90, note: "Dos largeur", spineSafe: true }
                    ],
                    'Lower': [
                        { name: "Presse à Cuisse", sets: 4, reps: "8-10", rest: 120, note: "Pieds bas pour quads", spineSafe: true },
                        { name: "Fentes Bulgares", sets: 3, reps: "10", rest: 90, note: "Unilatéral", spineSafe: true },
                        { name: "Leg Curl Allongé", sets: 4, reps: "12", rest: 60, note: "Ischios", spineSafe: true },
                        { name: "Mollets Presse", sets: 4, reps: "15", rest: 45, note: "Pas de rebond", spineSafe: true }
                    ],
                    'Bras': [
                        { name: "Curl Marteau", sets: 4, reps: "10-12", rest: 60, note: "Gros avant-bras", spineSafe: true },
                        { name: "Barre Front Triceps", sets: 4, reps: "10-12", rest: 90, note: "Masse triceps", spineSafe: true },
                        { name: "Curl Inversé", sets: 3, reps: "15", rest: 45, note: "Dessus avant-bras", spineSafe: true },
                        { name: "Curl Incliné", sets: 3, reps: "12", rest: 60, note: "Biceps stretch", spineSafe: true },
                        { name: "Extensions Corde", sets: 3, reps: "15", rest: 45, note: "Finish triceps", spineSafe: true },
                        { name: "Flexion Poignet", sets: 3, reps: "20", rest: 30, note: "Flexeurs avant-bras", spineSafe: true },
                        { name: "Extension Poignet", sets: 3, reps: "20", rest: 30, note: "Extenseurs avant-bras", spineSafe: true }
                    ],
                    'Push': [{name: "Dev Incliné", sets:4, reps:10, rest:90}, {name:"Élévations Latérales", sets:5, reps:15, rest:45}, {name:"Pecs Machine", sets:3, reps:12, rest:60}, {name:"Triceps Poulie", sets:3, reps:12, rest:60}],
                    'Pull': [{name: "Tirage Vertical", sets:4, reps:10, rest:90}, {name:"Rowing Machine", sets:4, reps:12, rest:90}, {name:"Face Pull", sets:4, reps:15, rest:60}, {name:"Curl Pupitre", sets:3, reps:12, rest:60}],
                    'Legs': [{name: "Goblet Squat", sets:4, reps:12, rest:90}, {name:"Leg Extension", sets:4, reps:15, rest:60}, {name:"Leg Curl Assis", sets:4, reps:15, rest:60}, {name:"Mollets Assis", sets:4, reps:15, rest:45}]
                },

                async initApp() {
                    lucide.createIcons();
                    this.loadLocal();
                    this.selectedDay = this.getTodayName();
                    
                    // AUTO-CONNECT FIREBASE
                    this.connectFirebase();
                    
                    setTimeout(() => this.renderChart(), 200);
                },

                connectFirebase() {
                    try {
                        if (!firebase.apps.length) {
                            firebase.initializeApp(this.firebaseConfig);
                            db = firebase.firestore();
                            console.log("Firebase Connected");
                            this.syncStatus = 'online';
                            this.listenToCloud();
                        }
                    } catch (e) {
                        console.error("Firebase Error", e);
                        this.syncStatus = 'error';
                        alert("Erreur de connexion Cloud. Vérifie ta console.");
                    }
                },

                listenToCloud() {
                    // Listen to 'superman_user' document
                    db.collection('users').doc('superman_user').onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            this.currentWeight = data.currentWeight || this.currentWeight;
                            this.xp = data.xp || this.xp;
                            this.completedSets = data.completedSets || {};
                            this.history = data.history || {};
                            this.weightHistory = data.weightHistory || [];
                            this.renderChart();
                        }
                    }, (error) => {
                        console.error("Cloud Listener Error:", error);
                        // Often happens if Firestore DB is not created in Test Mode
                        if(error.code === 'permission-denied') {
                            alert("Erreur Permission: Crée ta DB Firestore en 'Mode Test' dans la console Firebase.");
                        }
                    });
                },

                pushToCloud() {
                    if (db) {
                        db.collection('users').doc('superman_user').set({
                            currentWeight: this.currentWeight,
                            xp: this.xp,
                            completedSets: this.completedSets,
                            history: this.history,
                            weightHistory: this.weightHistory,
                            lastUpdate: new Date().toISOString()
                        }, { merge: true });
                    }
                    this.saveLocal();
                },

                // --- LOCAL LOGIC ---
                loadLocal() {
                    const d = JSON.parse(localStorage.getItem('superman_v9'));
                    if(d) {
                        this.currentWeight = d.currentWeight;
                        this.xp = d.xp;
                        this.weightHistory = d.weightHistory || [];
                        this.history = d.history || {};
                    }
                },
                saveLocal() {
                    localStorage.setItem('superman_v9', JSON.stringify({
                        currentWeight: this.currentWeight,
                        xp: this.xp,
                        weightHistory: this.weightHistory,
                        history: this.history
                    }));
                },

                // --- CORE FEATURES ---
                updateWeight(delta) {
                    this.currentWeight = Math.round((this.currentWeight + delta) * 100) / 100;
                    this.pushToCloud();
                },
                
                stepWeight(exName, delta) {
                    let current = parseFloat(this.history[exName] || 0);
                    let newVal = current + delta;
                    if(newVal < 0) newVal = 0;
                    // Round to nearest 0.25 or logical step
                    newVal = Math.round(newVal * 100) / 100;
                    this.history[exName] = newVal;
                    this.pushToCloud();
                },

                getSavedWeight(name) { return this.history[name] || 0; },
                getHistory(name) { return this.history[name] ? this.history[name] + 'kg' : '-'; },
                isPR(name) { return false; },

                // --- CARB CYCLING & PROGRAM ---
                getTodayName() {
                    const d = new Date().getDay();
                    const map = {1:'Upper', 2:'Lower', 3:'Bras', 4:'Push', 5:'Pull', 6:'Legs', 0:'Upper'};
                    return map[d];
                },
                isHighCarb() {
                    return ['Lower', 'Pull', 'Legs'].includes(this.selectedDay);
                },

                startWorkoutSession() { this.tab = 'train'; this.selectedDay = this.getTodayName(); },
                
                toggleSet(day, exIdx, set, rest) {
                    const k = `${day}-${exIdx}-${set}`;
                    if(this.completedSets[k]) {
                        delete this.completedSets[k];
                        this.xp -= 10;
                    } else {
                        this.completedSets[k] = true;
                        this.xp += 20;
                        this.startTimer(rest);
                        if(navigator.vibrate) navigator.vibrate(50);
                    }
                    this.pushToCloud();
                },

                finishWorkout() {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    this.xp += 100;
                    this.completedSets = {}; // Reset daily sets
                    this.pushToCloud();
                    alert("Mission Terminée. +100 XP. Données synchronisées.");
                    this.tab = 'home';
                },

                // --- TIMER ---
                startTimer(sec) {
                    if(this.timer.interval) clearInterval(this.timer.interval);
                    this.timer.total = sec;
                    this.timer.current = sec;
                    this.timer.active = true;
                    this.timer.interval = setInterval(() => {
                        this.timer.current--;
                        if(this.timer.current <= 0) {
                            this.stopTimer();
                            if(navigator.vibrate) navigator.vibrate([200,100,200]);
                        }
                    }, 1000);
                },
                stopTimer() { this.timer.active = false; clearInterval(this.timer.interval); },

                // --- UTILS ---
                get xpProgress() { return (this.xp % 1000) / 10; },
                get userLevel() { return Math.floor(this.xp / 1000) + 1; },
                getRankName() { const l = this.userLevel; return l < 5 ? 'Recrue' : l < 10 ? 'Soldat' : 'Superman'; },
                resetAll() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } },

                renderChart() {
                    const ctx = document.getElementById('weightChart');
                    if(!ctx) return;
                    if(this.chartInstance) this.chartInstance.destroy();
                    
                    const data = this.weightHistory.length ? this.weightHistory.map(x=>x.weight) : [105];
                    const labels = this.weightHistory.length ? this.weightHistory.map(x=>x.date) : ['Start'];

                    this.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                borderColor: '#3b82f6',
                                borderWidth: 2,
                                tension: 0.4,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: {display: false} },
                            scales: { x: {display: false}, y: {display: false} }
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>