<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    <title>ROAD TO SUPERMAN | V45 STABLE</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Chakra+Petch:ital,wght@0,400;0,600;0,700;1,700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        
        /* NATIVE SCROLL & TOUCH */
        html { touch-action: manipulation; -webkit-text-size-adjust: 100%; overscroll-behavior-y: none; height: 100%; }
        body { 
            font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; 
            overflow: hidden; -webkit-tap-highlight-color: transparent; user-select: none; 
            -webkit-user-select: none; padding-bottom: env(safe-area-inset-bottom); position: fixed; width: 100%;
        }
        /* Lock body scroll when modal is open */
        body.modal-open { overflow: hidden !important; }

        input { user-select: text; -webkit-user-select: text; font-size: 16px !important; }

        #scroller {
            height: 100%; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; width: 100vw; max-width: 100vw;
        }

        .font-tech { font-family: 'Chakra Petch', sans-serif; }
        .font-logo { font-family: 'Russo One', sans-serif; }

        .bg-aurora {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle at 50% -20%, #0f172a 0%, #000000 80%);
            pointer-events: none;
        }
        .bg-aurora::after {
            content: ''; position: absolute; inset: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
            opacity: 0.4;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }
        
        .header-solid {
            background-color: #020617; position: sticky; top: 0; z-index: 50;
            margin-left: -1rem; margin-right: -1rem; padding: 0.5rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 -40px 0 40px #020617, 0 10px 30px rgba(0,0,0,0.8);
        }

        .hero-btn {
            width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; font-size: 1.5rem; color: #94a3b8; transition: transform 0.1s;
        }
        .hero-btn:active { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: white; transform: scale(0.9); }

        .stepper-btn {
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1); border-radius: 8px; font-weight: bold; transition: transform 0.1s;
        }
        .stepper-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.9); }

        .set-btn { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .set-btn.done {
            background: #2563eb; color: white; border-color: #2563eb;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.6); transform: scale(1.1);
        }
        
        .logo-container { text-align: center; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .logo-top { font-family: 'Chakra Petch', sans-serif; font-size: 0.7rem; letter-spacing: 0.4em; color: #94a3b8; font-weight: 700; margin-bottom: -3px; text-transform: uppercase; }
        .logo-main { 
            font-family: 'Russo One', sans-serif; font-size: 2.2rem; line-height: 1;
            background: linear-gradient(180deg, #ffffff 20%, #3b82f6 90%); -webkit-background-clip: text; color: transparent;
            text-shadow: 0 0 20px rgba(37, 99, 235, 0.6); letter-spacing: 1px; text-transform: uppercase;
        }

        .modal-enter { transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
        .modal-enter-start { opacity: 0; transform: scale(0.95); }
        .modal-enter-end { opacity: 1; transform: scale(1); }
        
        .cardio-gradient { background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(234, 88, 12, 0.05)); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .weight-display-btn {
            background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; padding: 6px 12px; font-family: 'Russo One', sans-serif;
            color: white; font-size: 1.2rem; min-width: 80px; text-align: center; transition: all 0.2s;
        }
        .weight-display-btn:active { transform: scale(0.95); border-color: #3b82f6; background: rgba(59, 130, 246, 0.2); }
        .keypad-btn { @apply flex items-center justify-center rounded-xl bg-slate-800 border border-white/10 text-xl font-bold text-white transition active:scale-95 active:bg-slate-700; height: 50px; }
        .keypad-quick { @apply bg-slate-700/50 text-xs font-mono text-blue-300 border-blue-500/20 h-10 rounded-lg; }

        .login-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body x-data="app()" x-init="initApp()" class="h-screen flex flex-col text-slate-200" :class="{ 'modal-open': isModalOpen }">

    <div class="bg-aurora"></div>
    
    <div class="absolute top-4 left-4 z-50 flex items-center gap-2 bg-slate-900/80 px-2 py-1 rounded-full border border-white/5 backdrop-blur-md cursor-pointer" @click="handleSyncClick()">
        <div class="w-2 h-2 rounded-full transition-colors duration-500" :class="getSyncColor()"></div>
        <span class="text-[9px] font-mono uppercase tracking-widest text-slate-300" x-text="syncStatus"></span>
        <i x-show="pendingChanges" class="w-3 h-3 text-yellow-400 animate-spin" data-lucide="loader-2"></i>
    </div>
    
    <div class="absolute top-4 right-4 z-50">
         <button @click="handleProfileClick()" class="w-8 h-8 rounded-full overflow-hidden border border-white/20 bg-slate-800 flex items-center justify-center">
             <img x-show="user && user.photoURL" :src="user?.photoURL" class="w-full h-full object-cover">
             <i x-show="!user" data-lucide="user" class="w-4 h-4 text-slate-400"></i>
         </button>
    </div>

    <div x-show="!user && authReady" class="login-overlay" x-transition:enter="transition ease-out duration-500" x-cloak>
        <div class="logo-container mb-8 scale-125">
            <div class="logo-top">ROAD TO</div>
            <div class="logo-main">SUPERMAN</div>
        </div>
        <div class="glass-panel p-8 rounded-3xl max-w-sm w-full mx-6 border-blue-500/30 text-center">
            <h2 class="text-xl font-bold text-white mb-2">Identification Requise</h2>
            <p class="text-sm text-slate-400 mb-6">Synchronisation Cloud Active.</p>
            <button @click="loginWithGoogle()" class="w-full py-3 bg-white text-black rounded-xl font-bold flex items-center justify-center gap-3 active:scale-95 transition hover:bg-slate-200">
                <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" /><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" /></svg>
                Connexion Google
            </button>
        </div>
    </div>

    <div class="logo-container">
        <div class="logo-top">ROAD TO</div>
        <div class="logo-main">SUPERMAN</div>
    </div>

    <header class="flex-none px-6 pb-2 pt-0 flex justify-between items-center z-20">
        <div class="relative w-full">
            <div class="flex justify-between text-[10px] uppercase font-bold mb-1 text-blue-300 font-tech">
                <span>SEMAINE <span x-text="currentWeek"></span> • LVL <span x-text="userLevel"></span></span>
                <span x-text="Math.floor(xp) + ' XP'"></span>
            </div>
            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden border border-white/10 shadow-inner">
                <div class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-1000" :style="`width: ${xpProgress}%`"></div>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-3 pb-32 relative scroll-smooth" id="scroller">
        
        <div x-show="tab === 'home'" class="space-y-4" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95">
            
            <div class="glass-panel rounded-3xl p-5 relative overflow-hidden group text-center border border-blue-500/20">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-blue-600/20 rounded-full blur-[80px] -mt-20"></div>
                
                <div class="flex justify-between items-center mb-3 relative z-10">
                     <p class="text-[10px] text-blue-300 font-bold uppercase tracking-[0.2em] font-tech text-center w-full">Cible : 85.0 KG</p>
                     <button @click="openWeightHistory()" class="absolute right-0 top-0 p-2 text-slate-400 hover:text-white bg-white/5 rounded-lg hover:bg-white/10 transition active:scale-90"><i data-lucide="clipboard-list" class="w-4 h-4"></i></button>
                </div>
                
                <div class="flex items-center justify-center gap-4 relative z-10 mb-3">
                    <button @click="updateWeight(-0.1)" class="hero-btn hover:text-white hover:border-blue-500"><i data-lucide="minus" class="w-5 h-5"></i></button>
                    
                    <div class="flex flex-col items-center w-40 cursor-pointer active:scale-95 transition-transform" @click="openKeypad('bodyweight')">
                        <span class="text-5xl font-logo text-white tabular-nums tracking-tight leading-none drop-shadow-2xl" x-text="currentWeight.toFixed(1)"></span>
                        <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Kilogrammes</span>
                    </div>
                    
                    <button @click="updateWeight(0.1)" class="hero-btn hover:text-white hover:border-blue-500"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </div>

                <div class="inline-block bg-black/40 px-3 py-1 rounded-full border border-white/5 backdrop-blur-sm">
                    <span class="text-[10px] font-mono text-red-400 font-bold">Déficit Actif : -1375 kcal</span>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-4">
                <div class="flex items-center gap-2 mb-3 border-b border-white/5 pb-2">
                    <i data-lucide="flask-conical" class="w-4 h-4 text-slate-400"></i>
                    <h3 class="text-xs font-bold text-slate-300 uppercase font-tech tracking-wider">Bio-Hacking Stack</h3>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <template x-for="(supp, key) in supplementsInfo">
                        <button @click="openSupp(key)" class="bg-slate-900/50 border border-white/5 rounded-xl p-2 flex flex-col items-center gap-1 transition active:scale-95 hover:border-white/20 group shadow-sm">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center transition-all shadow-lg" :class="supp.bg" x-html="supp.svg"></div>
                            <span class="text-[8px] font-bold uppercase text-slate-500 group-hover:text-white transition-colors" x-text="supp.short"></span>
                        </button>
                    </template>
                </div>
            </div>

            <div @click="activeNutri = true" class="glass-panel rounded-2xl p-4 border-l-4 relative overflow-hidden cursor-pointer hover:border-white/20 transition active:scale-[0.99]" :class="isHighCarb() ? 'border-l-green-500' : 'border-l-yellow-500'">
                <div class="absolute right-0 top-0 opacity-10 p-3"><i :data-lucide="isHighCarb() ? 'zap' : 'flame'" class="w-14 h-14"></i></div>
                <div class="relative z-10">
                     <div class="flex justify-between items-center mb-2">
                        <div>
                            <div class="text-[9px] font-bold text-slate-400 uppercase font-tech flex items-center gap-1">Cycle Métabolique <i data-lucide="info" class="w-3 h-3"></i></div>
                            <div class="text-lg font-bold font-logo" :class="isHighCarb() ? 'text-green-400' : 'text-yellow-400'" x-text="isHighCarb() ? 'HIGH CARB' : 'LOW CARB'"></div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-white font-logo tracking-tighter" x-text="macros.calories"></div>
                            <div class="text-[8px] text-slate-500 uppercase tracking-widest">Kcal Target</div>
                        </div>
                     </div>
                     <div class="space-y-1.5">
                        <div class="flex items-center gap-2 text-[9px] font-bold text-slate-400">
                            <span class="w-8 text-blue-400">PROT</span>
                            <div class="flex-1 h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-blue-500 rounded-full" style="width: 50%"></div></div>
                            <span class="text-white w-8 text-right" x-text="macros.protein"></span>
                        </div>
                        <div class="flex items-center gap-2 text-[9px] font-bold text-slate-400">
                            <span class="w-8 text-yellow-400">LIP</span>
                            <div class="flex-1 h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-yellow-500 rounded-full" style="width: 30%"></div></div>
                            <span class="text-white w-8 text-right" x-text="macros.fats"></span>
                        </div>
                        <div class="flex items-center gap-2 text-[9px] font-bold text-slate-400">
                            <span class="w-8 text-green-400">GLU</span>
                            <div class="flex-1 h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-green-500 rounded-full" :style="`width: ${isHighCarb() ? '60%' : '20%'}`"></div></div>
                            <span class="text-white w-8 text-right" x-text="isHighCarb() ? macros.carbsHigh : macros.carbsLow"></span>
                        </div>
                     </div>
                </div>
            </div>

            <div @click="openCardioInfo()" class="glass-panel p-4 rounded-2xl border border-orange-500/30 cardio-gradient relative overflow-hidden cursor-pointer hover:border-orange-500/50 transition active:scale-[0.99] group">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-orange-500/10 rounded-full blur-xl"></div>
                <div class="flex items-center gap-3 mb-3 relative z-10 border-b border-orange-500/20 pb-2">
                    <div class="w-8 h-8 rounded-lg bg-orange-500/20 flex items-center justify-center text-orange-400 border border-orange-500/30">
                        <i data-lucide="flame" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-orange-400 text-xs uppercase font-tech flex items-center gap-2">
                            Cardio S<span x-text="getCardioWeekBlock()"></span> <i data-lucide="info" class="w-3 h-3 text-orange-400/50"></i>
                        </h3>
                        <p class="text-[9px] text-slate-400">Matin & Soir • Fat Burner</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mb-3">
                     <div class="bg-orange-900/30 p-1.5 rounded-lg border border-orange-500/20 text-center">
                         <div class="text-[8px] text-orange-300 uppercase mb-0.5">Durée</div>
                         <div class="text-xs font-bold text-white font-mono" x-text="getCardioData().duration"></div>
                     </div>
                     <div class="bg-orange-900/30 p-1.5 rounded-lg border border-orange-500/20 text-center">
                         <div class="text-[8px] text-orange-300 uppercase mb-0.5">Vitesse</div>
                         <div class="text-xs font-bold text-white font-mono flex justify-center items-center gap-1"><i data-lucide="zap" class="w-2 h-2"></i> <span x-text="getCardioData().speed"></span></div>
                     </div>
                     <div class="bg-orange-900/30 p-1.5 rounded-lg border border-orange-500/20 text-center">
                         <div class="text-[8px] text-orange-300 uppercase mb-0.5">Pente</div>
                         <div class="text-xs font-bold text-white font-mono flex justify-center items-center gap-1"><i data-lucide="mountain" class="w-2 h-2"></i> <span x-text="getCardioData().incline"></span></div>
                     </div>
                </div>

                <div @click.stop class="flex items-center gap-3 bg-orange-500/10 p-2.5 rounded-lg border border-orange-500/20 hover:bg-orange-500/20 transition cursor-pointer" @click="toggleCardio()">
                    <div class="w-4 h-4 rounded border border-orange-500 bg-slate-900 flex items-center justify-center transition-colors" :class="daily.cardioDone ? 'bg-orange-500' : ''">
                        <i data-lucide="check" class="w-3 h-3 text-white" x-show="daily.cardioDone"></i>
                    </div>
                    <span class="text-[9px] font-bold text-orange-200 uppercase tracking-wide" x-text="daily.cardioDone ? 'Mission Validée' : 'Valider Mission'"></span>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6 text-center border border-emerald-500/30 relative overflow-hidden bg-[#020617] shadow-[0_0_30px_rgba(16,185,129,0.1)]">
                <div class="absolute inset-0 bg-gradient-to-b from-emerald-900/10 to-transparent"></div>
                <div class="relative z-10">
                    <div class="mb-3 inline-flex items-center justify-center w-10 h-10 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 animate-pulse">
                        <i data-lucide="brain-circuit" class="w-5 h-5"></i>
                    </div>
                    <p class="text-sm font-bold text-white leading-relaxed font-tech italic mb-3" x-text="'&quot;' + randomFact.text + '&quot;'"></p>
                    <div class="flex justify-center items-center gap-3">
                         <span class="text-[8px] text-emerald-600 font-bold uppercase tracking-widest bg-emerald-900/20 px-2 py-1 rounded" x-text="randomFact.source"></span>
                         <button @click="generateFact()" class="text-slate-600 hover:text-white transition active:scale-90"><i data-lucide="refresh-cw" class="w-3 h-3"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="h-20"></div>
        </div>

        <div x-show="tab === 'train'" class="space-y-4" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-x-10 opacity-0">
            
            <div class="header-solid">
                <div class="mb-2 flex items-center gap-2">
                    <span class="text-[8px] font-bold text-slate-500 uppercase tracking-wider w-8">Prog.</span>
                    <div class="flex-1 h-1 bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-green-500 transition-all duration-500" :style="`width: ${sessionProgress}%`"></div>
                    </div>
                    <span class="text-[8px] font-bold text-green-400 w-6 text-right" x-text="sessionProgress + '%'"></span>
                </div>

                <div class="flex justify-between items-center mb-2 bg-white/5 p-1 rounded-lg mx-1 border border-white/10">
                    <button @click="changeWeek(-1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/10 rounded-lg transition active:scale-90"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <div class="text-center">
                         <span class="text-[9px] text-slate-500 uppercase font-bold tracking-widest block">Planning</span>
                        <span class="text-xs font-bold text-white font-tech uppercase">Semaine <span class="text-blue-400 text-sm" x-text="currentWeek"></span></span>
                    </div>
                    <button @click="changeWeek(1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/10 rounded-lg transition active:scale-90"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
                <div class="flex gap-1.5 overflow-x-auto hide-scrollbar pb-1 justify-center">
                    <template x-for="day in splitOrder">
                        <button @click="selectedDay = day" class="px-3 py-2 rounded-lg text-[9px] font-bold uppercase border transition-all whitespace-nowrap font-tech"
                        :class="selectedDay === day ? 'bg-blue-600 border-blue-500 text-white shadow-lg' : 'bg-slate-800/50 border-slate-700 text-slate-500'">
                            <span x-text="day"></span>
                        </button>
                    </template>
                </div>
            </div>

            <div @click="openCardioInfo()" class="glass-panel p-4 rounded-2xl border border-orange-500/30 cardio-gradient relative overflow-hidden cursor-pointer hover:border-orange-500/50 transition active:scale-[0.99] group">
               <div class="absolute -right-4 -top-4 w-24 h-24 bg-orange-500/10 rounded-full blur-xl"></div>
                <div class="flex items-center gap-3 mb-3 relative z-10 border-b border-orange-500/20 pb-2">
                    <div class="w-8 h-8 rounded-lg bg-orange-500/20 flex items-center justify-center text-orange-400 border border-orange-500/30">
                        <i data-lucide="flame" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-orange-400 text-xs uppercase font-tech flex items-center gap-2">
                            Cardio <span class="text-orange-200">S<span x-text="getCardioWeekBlock()"></span></span> <i data-lucide="info" class="w-3 h-3 text-orange-400/50"></i>
                        </h3>
                        <p class="text-[9px] text-slate-400">Matin & Soir • <span x-text="getCardioData().summary"></span></p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 mb-3">
                     <div class="bg-orange-900/30 p-1.5 rounded-lg border border-orange-500/20 text-center">
                         <div class="text-[8px] text-orange-300 uppercase mb-0.5">Durée</div>
                         <div class="text-xs font-bold text-white font-mono" x-text="getCardioData().duration"></div>
                     </div>
                     <div class="bg-orange-900/30 p-1.5 rounded-lg border border-orange-500/20 text-center">
                         <div class="text-[8px] text-orange-300 uppercase mb-0.5">Vitesse</div>
                         <div class="text-xs font-bold text-white font-mono flex justify-center items-center gap-1"><i data-lucide="zap" class="w-2 h-2"></i> <span x-text="getCardioData().speed"></span></div>
                     </div>
                     <div class="bg-orange-900/30 p-1.5 rounded-lg border border-orange-500/20 text-center">
                         <div class="text-[8px] text-orange-300 uppercase mb-0.5">Pente</div>
                         <div class="text-xs font-bold text-white font-mono flex justify-center items-center gap-1"><i data-lucide="mountain" class="w-2 h-2"></i> <span x-text="getCardioData().incline"></span></div>
                     </div>
                </div>
                
                <div @click.stop class="flex items-center gap-3 bg-orange-500/10 p-2.5 rounded-lg border border-orange-500/20 hover:bg-orange-500/20 transition cursor-pointer" @click="toggleCardio()">
                    <div class="w-4 h-4 rounded border border-orange-500 bg-slate-900 flex items-center justify-center transition-colors" :class="daily.cardioDone ? 'bg-orange-500' : ''">
                        <i data-lucide="check" class="w-3 h-3 text-white" x-show="daily.cardioDone"></i>
                    </div>
                    <span class="text-[9px] font-bold text-orange-200 uppercase tracking-wide" x-text="daily.cardioDone ? 'Mission Validée' : 'Valider Mission'"></span>
                </div>
            </div>

            <div class="space-y-3">
                <template x-for="(ex, index) in getExercises(selectedDay)" :key="index">
                    <div class="glass-panel rounded-2xl overflow-hidden border-l-4 relative transition-all duration-300" :class="ex.isPopeye ? 'border-l-green-500' : 'border-l-blue-500'">
                        <div x-show="ex.isPopeye" class="absolute top-0 right-0 bg-green-500/20 text-green-400 text-[8px] px-2 py-0.5 rounded-bl-lg font-bold font-tech">POPEYE</div>

                        <div class="p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1 pr-2">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <h4 @click="openExerciseInfo(ex)" class="font-bold text-white text-sm font-tech border-b border-dashed border-slate-600 cursor-help hover:text-blue-400 transition" x-text="ex.name"></h4>
                                        <button @click.stop="openExerciseInfo(ex)" class="text-[8px] bg-blue-900/40 text-blue-300 border border-blue-500/30 px-1.5 py-0.5 rounded uppercase font-bold hover:bg-blue-800/50 transition">
                                            <i data-lucide="brain-circuit" class="w-2 h-2 inline mr-1"></i>Analyse
                                        </button>
                                    </div>
                                    <div class="flex gap-2 mt-2 items-center flex-wrap">
                                        <div class="flex items-center gap-1 text-[9px] bg-blue-900/30 text-blue-300 px-1.5 py-0.5 rounded-lg border border-blue-500/30 font-mono">
                                            <i data-lucide="timer" class="w-3 h-3"></i>
                                            <span x-text="ex.tempo"></span>
                                        </div>
                                        <div class="text-[9px] bg-white/5 px-2 py-0.5 rounded-lg text-slate-300 font-bold" x-text="ex.reps + ' Reps'"></div>
                                        
                                        <a :href="'https://www.youtube.com/results?search_query=technique+execution+' + ex.name" target="_blank" @click.stop class="flex items-center gap-1 bg-red-600/10 border border-red-600/40 text-red-500 px-2 py-0.5 rounded-lg hover:bg-red-600 hover:text-white transition text-[8px] font-bold uppercase ml-auto active:scale-95 cursor-pointer z-10">
                                            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>
                                            Demo
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center justify-between bg-black/40 p-1.5 rounded-lg mb-3 border border-white/5">
                                <div class="pl-2 text-[9px] text-slate-500 font-mono uppercase">Last: <span x-text="getHistory(ex.name)" class="text-slate-300"></span></div>
                                <button @click="openKeypad(ex.name)" class="weight-display-btn active:scale-95">
                                    <span x-text="getSavedWeight(ex.name) + ' kg'"></span>
                                </button>
                            </div>

                            <div class="flex flex-wrap gap-2 justify-center">
                                <template x-for="set in getSetsForWeek(ex)">
                                    <button @click="toggleSet(selectedDay, index, set, ex.rest)"
                                        class="w-10 h-9 rounded-lg border border-slate-700 flex items-center justify-center font-bold text-sm set-btn bg-slate-800/50 text-slate-500 font-mono"
                                        :class="isSetDone(selectedDay, index, set) ? 'done' : ''">
                                        <span x-text="set"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
                
                <div class="h-32"></div>

                <button @click="finishWorkout()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl text-white font-logo text-base uppercase tracking-widest shadow-xl shadow-blue-900/40 mb-10 border-t border-white/20 active:scale-95 transition">
                    Terminer Mission
                </button>
            </div>
        </div>

        <div x-show="activeWeightModal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak>
            <div class="glass-panel border border-white/10 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl max-h-[80vh] flex flex-col" @click.away="activeWeightModal = false">
                <button @click="activeWeightModal = false" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <h3 class="text-xl font-logo text-white mb-4 text-center">Historique Poids</h3>
                <div class="flex gap-2 mb-6">
                    <input type="number" x-model="manualWeight" placeholder="104.2" class="flex-1 bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-white font-bold outline-none focus:border-blue-500">
                    <button @click="logManualWeight()" class="bg-blue-600 text-white px-4 rounded-xl font-bold hover:bg-blue-500 active:scale-95 transition">OK</button>
                </div>
                <div class="h-40 w-full mb-4 bg-slate-900/50 rounded-xl p-2 border border-white/5 relative">
                    <canvas id="weightHistoryChart"></canvas>
                </div>
                <div class="flex-1 overflow-y-auto space-y-2">
                    <template x-for="log in weightHistory.slice().reverse()">
                        <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg text-xs border border-white/5"><span class="text-slate-400" x-text="log.date"></span><span class="text-white font-bold font-mono" x-text="log.weight + ' kg'"></span></div>
                    </template>
                </div>
            </div>
        </div>

        <div x-show="activeNutri" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeNutri = false"><div class="glass-panel border border-green-500/30 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl"><button @click="activeNutri = false" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button><div class="text-center mb-6"><div class="w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center mx-auto mb-3 border border-green-500/20"><i :data-lucide="isHighCarb() ? 'zap' : 'leaf'" class="w-8 h-8 text-green-400"></i></div><h3 class="text-2xl font-logo text-white mb-1" :class="isHighCarb() ? 'text-green-400' : 'text-yellow-400'" x-text="isHighCarb() ? 'HIGH CARB DAY' : 'LOW CARB DAY'"></h3></div><div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 mb-4"><h4 class="text-[10px] font-bold text-slate-300 uppercase mb-2">Pourquoi ce cycle ?</h4><p class="text-sm text-slate-300 leading-relaxed text-justify" x-text="getNutritionExplanation()"></p></div></div></div>
        
        <div x-show="activeCardio" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeCardio = false"><div class="glass-panel border border-orange-500/30 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl max-h-[80vh] overflow-y-auto"><button @click="activeCardio = false" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button><div class="text-center mb-6"><div class="w-14 h-14 rounded-full bg-orange-500/10 flex items-center justify-center mx-auto mb-3 border border-orange-500/20"><i data-lucide="flame" class="w-7 h-7 text-orange-500"></i></div><h3 class="text-2xl font-logo text-white mb-1">Semaine <span x-text="currentWeek"></span></h3><span class="text-[10px] bg-orange-500/20 text-orange-300 px-3 py-1 rounded-full border border-orange-500/30 font-mono uppercase tracking-wider" x-text="getCardioData().focus"></span></div><div class="space-y-4"><div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5"><h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Détails de la séance</h4><div class="text-sm text-white font-mono leading-relaxed space-y-2" x-html="getCardioData().details"></div><div class="mt-3 pt-3 border-t border-white/5 text-xs text-orange-300 flex justify-between"><span>Calories Estimées</span><span class="font-bold" x-text="getCardioData().calories + ' kcal'"></span></div></div><div class="bg-orange-900/10 p-4 rounded-2xl border border-orange-500/20"><h4 class="text-[10px] font-bold text-orange-400 uppercase mb-2 flex items-center gap-2"><i data-lucide="microscope" class="w-3 h-3"></i> Science</h4><p class="text-sm text-slate-200 leading-relaxed text-justify" x-text="getCardioData().science"></p></div></div></div></div>
        
        <div x-show="activeExercise !== null" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeExercise = null">
            <div class="glass-panel border border-blue-500/30 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl max-h-[85vh] overflow-y-auto flex flex-col">
                <button @click="activeExercise = null" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-logo text-white mb-2 leading-tight" x-text="activeExercise?.name"></h3>
                    <span class="text-[10px] bg-blue-500/20 text-blue-300 px-3 py-1 rounded-full border border-blue-500/30 font-mono uppercase tracking-wider" x-text="'Tempo: ' + activeExercise?.tempo"></span>
                </div>
                
                <div class="bg-slate-900/80 p-2 rounded-xl border border-white/5 mb-4">
                    <h4 class="text-[9px] font-bold text-slate-400 uppercase mb-1 ml-2">Progression de Force</h4>
                    <div class="h-32 w-full relative"><canvas id="exerciseChart"></canvas></div>
                </div>

                <div class="bg-blue-900/10 p-5 rounded-2xl border border-blue-500/20">
                    <h4 class="text-[10px] font-bold text-blue-400 uppercase mb-2 flex items-center gap-2"><i data-lucide="microscope" class="w-3 h-3"></i> Analyse Biomécanique</h4>
                    <p class="text-sm text-slate-200 leading-relaxed text-justify font-medium" x-text="activeExercise?.why"></p>
                </div>
            </div>
        </div>

        <div x-show="activeSupp !== null" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeSupp = null"><div class="glass-panel border border-white/10 rounded-3xl p-6 w-full max-w-sm relative overflow-hidden shadow-2xl"><div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r" :class="supplementsInfo[activeSupp]?.gradient"></div><button @click="activeSupp = null" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button><div class="text-center mb-6 mt-2"><div class="w-16 h-16 rounded-full flex items-center justify-center mb-4 mx-auto border-2 shadow-[0_0_20px_rgba(255,255,255,0.1)]" :class="supplementsInfo[activeSupp]?.color + ' ' + supplementsInfo[activeSupp]?.bg + ' border-white/10'" x-html="supplementsInfo[activeSupp]?.svg"></div><h3 class="text-2xl font-logo text-white mb-1" x-text="supplementsInfo[activeSupp]?.title"></h3></div><div class="space-y-4"><div class="bg-white/5 p-4 rounded-xl border border-white/10"><h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Mécanisme d'action</h4><p class="text-sm text-slate-200 leading-relaxed text-justify" x-text="supplementsInfo[activeSupp]?.text"></p></div><div class="flex items-center gap-3 bg-slate-900/50 p-3 rounded-xl border border-white/5"><i data-lucide="clock" class="w-5 h-5 text-slate-400"></i><div><span class="text-[10px] font-bold text-slate-500 uppercase block">Protocole</span><span class="text-xs text-white font-mono font-bold" x-text="supplementsInfo[activeSupp]?.dose"></span></div></div></div></div></div>

        <div x-show="keypadOpen" class="fixed inset-0 z-[90] flex items-end justify-center bg-black/80 backdrop-blur-sm" x-transition:enter="modal-enter" x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0" x-cloak @click.self="closeKeypad()"><div class="glass-panel w-full max-w-md rounded-t-3xl p-6 border-t border-white/20 bg-[#0f172a] shadow-2xl"><div class="flex justify-between items-center mb-6"><span class="text-xs text-slate-400 font-bold uppercase tracking-widest">Saisir la Charge</span><button @click="closeKeypad()" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="text-center mb-8"><span class="text-6xl font-logo text-white" x-text="tempWeight"></span><span class="text-xl text-blue-500 font-bold ml-2">KG</span></div><div class="grid grid-cols-4 gap-3 mb-6"><button @click="adjustTempWeight(10)" class="keypad-quick">+10</button><button @click="adjustTempWeight(5)" class="keypad-quick">+5</button><button @click="adjustTempWeight(2.5)" class="keypad-quick">+2.5</button><button @click="adjustTempWeight(1.25)" class="keypad-quick">+1.25</button><button @click="adjustTempWeight(-10)" class="keypad-quick text-red-400 border-red-500/20">-10</button><button @click="adjustTempWeight(-5)" class="keypad-quick text-red-400 border-red-500/20">-5</button><button @click="adjustTempWeight(-2.5)" class="keypad-quick text-red-400 border-red-500/20">-2.5</button><button @click="adjustTempWeight(-1.25)" class="keypad-quick text-red-400 border-red-500/20">-1.25</button></div><div class="grid grid-cols-3 gap-3 mb-4"><button @click="appendDigit('1')" class="keypad-btn">1</button><button @click="appendDigit('2')" class="keypad-btn">2</button><button @click="appendDigit('3')" class="keypad-btn">3</button><button @click="appendDigit('4')" class="keypad-btn">4</button><button @click="appendDigit('5')" class="keypad-btn">5</button><button @click="appendDigit('6')" class="keypad-btn">6</button><button @click="appendDigit('7')" class="keypad-btn">7</button><button @click="appendDigit('8')" class="keypad-btn">8</button><button @click="appendDigit('9')" class="keypad-btn">9</button><button @click="appendDigit('.')" class="keypad-btn">.</button><button @click="appendDigit('0')" class="keypad-btn">0</button><button @click="backspace()" class="keypad-btn text-red-400"><i data-lucide="delete" class="w-6 h-6"></i></button></div><button @click="confirmWeight()" class="w-full py-4 bg-blue-600 rounded-2xl text-white font-logo text-xl uppercase tracking-widest shadow-lg shadow-blue-900/50 active:scale-95 transition">VALIDER</button></div></div>

        <div x-show="tab === 'settings'" class="space-y-4">
             <div class="glass-panel p-5 rounded-2xl border border-green-500/30 flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400"><i data-lucide="cloud-lightning" class="w-5 h-5"></i></div>
                <div>
                    <h2 class="font-bold text-white text-sm font-tech uppercase">Sync Pro Active</h2>
                    <p class="text-xs text-slate-400 mt-1">Données sécurisées sur le Cloud.</p>
                    <p class="text-[10px] text-slate-500 mt-0.5" x-text="user ? 'Compte : ' + user.email : 'Non connecté'"></p>
                </div>
             </div>
             
             <button @click="logout()" class="w-full py-3 bg-slate-800 border border-white/10 rounded-xl text-slate-300 font-bold uppercase hover:bg-slate-700 transition">Déconnexion</button>
             
             <button @click="resetAll()" class="w-full py-4 text-red-500 text-xs border border-red-900/30 rounded-xl bg-red-900/10 font-bold uppercase hover:bg-red-900/20 transition active:scale-95">Reset Factory Data</button>
        </div>

    </main>

    <div x-show="timer.active" class="fixed bottom-0 inset-x-0 bg-[#020617] border-t border-blue-500/50 p-6 pb-8 z-50 rounded-t-[2.5rem] shadow-[0_-10px_60px_rgba(0,0,0,1)]" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-y-full">
        <div class="flex justify-between items-center mb-4 px-2">
            <span class="text-blue-400 text-xs font-bold uppercase animate-pulse font-tech tracking-widest">Récupération</span>
            <div class="flex gap-2">
                <button @click="adjustTimer(30)" class="text-xs bg-slate-800 px-2 py-1 rounded border border-white/10 text-white font-mono">+30s</button>
                <button @click="adjustTimer(-30)" class="text-xs bg-slate-800 px-2 py-1 rounded border border-white/10 text-white font-mono">-30s</button>
                <button @click="stopTimer()" class="text-slate-500 hover:text-white p-1"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
            </div>
        </div>
        <div class="text-center relative my-2">
            <span class="text-7xl font-logo font-bold text-white tabular-nums tracking-tighter drop-shadow-2xl" x-text="timer.current"></span>
            <span class="text-sm text-slate-500 absolute top-4 right-12 font-bold">SEC</span>
        </div>
        <div class="h-2 bg-slate-800 mt-6 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-1000 ease-linear" :style="`width: ${(timer.current/timer.total)*100}%`"></div>
        </div>
    </div>

    <div x-show="!timer.active && !keypadOpen" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-40 w-full max-w-xs">
        <div class="glass-panel rounded-full px-6 py-3 flex items-center justify-between gap-4 shadow-2xl border border-white/10 bg-black/60 backdrop-blur-xl ring-1 ring-white/5">
            <button @click="tab = 'home'" :class="tab==='home'?'text-blue-400 scale-110':'text-slate-500 hover:text-slate-300'" class="transition duration-300 active:scale-90"><i data-lucide="layout-grid" class="w-5 h-5"></i></button>
            <button @click="startWorkoutSession()" class="relative -top-5 group">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-blue-700 to-blue-500 flex items-center justify-center shadow-[0_0_20px_rgba(37,99,235,0.6)] border-2 border-white/10 text-white transform transition duration-300 group-active:scale-90 rotate-45 group-hover:rotate-0">
                    <i data-lucide="dumbbell" class="w-6 h-6 -rotate-45 group-hover:rotate-0 transition duration-300"></i>
                </div>
            </button>
            <button @click="tab = 'settings'" :class="tab==='settings'?'text-blue-400 scale-110':'text-slate-500 hover:text-slate-300'" class="transition duration-300 active:scale-90"><i data-lucide="settings" class="w-5 h-5"></i></button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCq4XRnYXwonhApbKhOztpe7PeaoJGl0xo",
            authDomain: "superman-app-a07e1.firebaseapp.com",
            projectId: "superman-app-a07e1",
            storageBucket: "superman-app-a07e1.firebasestorage.app",
            messagingSenderId: "434433392892",
            appId: "1:434433392892:web:0fc4f95f6cce07c70a5779"
        };

        // FIREBASE INIT AVEC PERSISTENCE (CORRECTION 1)
        let db, auth;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            auth = firebase.auth();
            
            // ACTIVER LE MODE HORS-LIGNE
            db.enablePersistence()
                .catch((err) => {
                    if (err.code == 'failed-precondition') {
                        console.log('Persistence failed: Multiple tabs open');
                    } else if (err.code == 'unimplemented') {
                        console.log('Persistence not supported by browser');
                    }
                });

        } catch (e) {
            console.error("Firebase init error", e);
        }

        function app() {
            return {
                // ETAT GLOBAL
                tab: 'home',
                authReady: false,
                user: null,
                syncStatus: 'OFFLINE',
                pendingChanges: 0,
                
                // DATA
                currentWeight: 105.0,
                currentWeek: 1,
                selectedDay: 'Lundi',
                xp: 0,
                
                // HISTORY & LOGS
                weightHistory: [],
                completedSets: {},
                history: {},      
                exerciseLogs: {}, 
                daily: { habits: { sleep: false, water: false, creatine: false, steps: false }, cardioDone: false },
                
                // UI STATES
                activeSupp: null,
                activeExercise: null,
                activeCardio: false,
                activeNutri: false,
                activeWeightModal: false,
                keypadOpen: false,
                tempWeight: "0",
                targetKey: null,
                manualWeight: '',
                randomFact: { text: "Loading...", source: "" },
                
                // Helper pour le scroll lock
                get isModalOpen() {
                    return this.activeExercise || this.activeWeightModal || this.activeCardio || this.activeNutri || this.activeSupp || this.keypadOpen;
                },
                
                // TIMER
                timer: { active: false, current: 0, total: 0, interval: null },
                
                // CHARTS
                historyChartInstance: null,
                exerciseChartInstance: null,

                // CONSTANTES
                macros: { protein: 0, fats: 0, carbsHigh: 0, carbsLow: 0, calories: 0 },
                supplementsInfo: {
                    creatine: { short: "Créatine", icon: "zap", title: "Créatine Monohydrate", dose: "5g / jour", text: "Sature les réserves de phosphocréatine (PCr) musculaires. Permet de régénérer l'ATP (énergie explosive) ultra-rapidement entre les séries. Résultat prouvé : +15% de force et de volume.", color: "text-purple-400", bg: "bg-purple-500/10", gradient: "from-purple-500 to-indigo-500", svg: `<svg class="w-5 h-5 text-purple-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>` },
                    omega3: { short: "Omega 3", icon: "fish", title: "Omega 3", dose: "2-3g / jour", text: "Indispensable en déficit calorique. Les Oméga-3 augmentent la fluidité des membranes cellulaires, ce qui améliore la sensibilité à l'insuline.", color: "text-yellow-400", bg: "bg-yellow-500/10", gradient: "from-yellow-400 to-orange-500", svg: `<svg class="w-5 h-5 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 12c.94-3.46 4.94-6 8.5-6 3.56 0 6.06 2.54 7 6-.94 3.47-3.44 6-7 6s-7.56-2.53-8.5-6Z"/><path d="M18 12v.5"/></svg>` },
                    magnesium: { short: "Magnésium", icon: "moon", title: "Magnésium Bisglycinate", dose: "300mg soir", text: "Le 'Valium de la nature'. Active le système parasympathique (rest & digest). Crucial pour un sommeil profond réparateur.", color: "text-blue-400", bg: "bg-blue-500/10", gradient: "from-blue-400 to-cyan-500", svg: `<svg class="w-5 h-5 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>` },
                    protein: { short: "Whey", icon: "milk", title: "Whey Isolate", dose: "40g Post", text: "L'outil chirurgical de la récupération. Absorption rapide pour stopper le catabolisme.", color: "text-slate-200", bg: "bg-slate-700/30", gradient: "from-slate-400 to-slate-600", svg: `<svg class="w-5 h-5 text-slate-200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2h8"/><path d="M9 2v2.79c0 .42.19.82.53 1.08l4.94 3.85a2.78 2.78 0 0 1 1.08 2.2v6.08a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-6.08c0-.9.38-1.76 1.08-2.2l4.94-3.85A1.78 1.78 0 0 0 12.53 4.8V2"/></svg>` }
                },
                factsDatabase: [{ text: "Discipline > Motivation.", source: "Jocko" }, { text: "Marche = Perte de gras sans fatigue.", source: "BioLayne" }, { text: "Le muscle se construit au lit, pas à la salle.", source: "Science" }],
                splitOrder: ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'],
                exercises: {
                    'Lundi': [ 
                        { name: "Dev. Couché Haltères", target: "PECS", tempo: "3-1-1-0", baseSets: 4, reps: "6-8", rest: 120, why: "L'amplitude des haltères est supérieure à la barre, étirant les fibres pectorales sous charge maximale. C'est le facteur mécanique n°1 de l'hypertrophie." },
                        { name: "Dev. Incliné Machine", target: "HAUT PECS", tempo: "3-0-1-1", baseSets: 3, reps: "10-12", rest: 90, why: "Cible le faisceau claviculaire pour l'aspect 'plastron'. La machine permet l'échec en sécurité." },
                        { name: "Dev. Militaire Haltères", target: "ÉPAULES", tempo: "3-0-1-0", baseSets: 3, reps: "8-10", rest: 90, why: "Masse globale des deltoïdes. Le dossier protège les lombaires." },
                        { name: "Élévations Latérales", target: "LARGEUR", tempo: "2-0-1-1", baseSets: 5, reps: "15-20", rest: 45, why: "Le secret pour la largeur (V-Taper). Volume élevé requis." },
                        { name: "Extensions Triceps Corde", target: "TRICEPS", tempo: "3-0-1-1", baseSets: 4, reps: "12-15", rest: 60, why: "Contracte intensément la longue portion du triceps." }
                    ],
                    'Mardi': [ 
                        { name: "Tractions", target: "DOS LARGE", tempo: "3-0-1-0", baseSets: 4, reps: "8-10", rest: 120, why: "Le mouvement roi pour la largeur du dos." },
                        { name: "Rowing Barre", target: "DOS EPAIS", tempo: "3-1-X-0", baseSets: 4, reps: "8-10", rest: 120, why: "Construit l'épaisseur et la densité du dos." },
                        { name: "Tirage Vertical", target: "DORSAL", tempo: "3-0-1-1", baseSets: 3, reps: "10-12", rest: 90, why: "Prise neutre pour une force mécanique optimale." },
                        { name: "Face Pull", target: "POSTURE", tempo: "2-1-1-1", baseSets: 4, reps: "15-20", rest: 60, why: "Crucial pour la santé de l'épaule et la posture." },
                        { name: "Curl Barre", target: "BICEPS", tempo: "3-0-1-0", baseSets: 4, reps: "8-10", rest: 90, why: "Constructeur de masse classique." }
                    ],
                    'Mercredi': [ 
                        { name: "Wrist Curl Barre", target: "AVANT-BRAS", tempo: "2-0-1-0", baseSets: 4, reps: "15-20", rest: 45, isPopeye: true, why: "Cible les fléchisseurs." },
                        { name: "Wrist Curl Haltère", target: "AVANT-BRAS", tempo: "2-0-1-0", baseSets: 3, reps: "15-20", rest: 30, isPopeye: true, why: "Travail unilatéral pour corriger les déséquilibres." },
                        { name: "Reverse Curl", target: "BRACHIAL", tempo: "3-0-1-0", baseSets: 4, reps: "12-15", rest: 60, isPopeye: true, why: "Cible le brachial antérieur." },
                        { name: "Marche Fermier", target: "GRIP", tempo: "Static", baseSets: 4, reps: "45s", rest: 90, isPopeye: true, why: "Exercice fonctionnel ultime pour le grip et les trapèzes." }
                    ],
                    'Jeudi': [ 
                        { name: "Squat", target: "CUISSES", tempo: "3-1-X-0", baseSets: 4, reps: "6-8", rest: 180, why: "Sollicite l'ensemble du bas du corps." },
                        { name: "Fentes", target: "FESSIERS", tempo: "3-0-1-0", baseSets: 3, reps: "10", rest: 120, why: "Stabilisation et force brute unilatérale." },
                        { name: "Leg Ext", target: "QUADS", tempo: "2-0-1-1", baseSets: 4, reps: "15-20", rest: 60, why: "Isolation pure du quadriceps en position raccourcie." },
                        { name: "Leg Curl", target: "ISCHIOS", tempo: "3-0-1-0", baseSets: 4, reps: "10-12", rest: 90, why: "Essentiel pour l'équilibre du genou." },
                        { name: "Mollets Debout", target: "MOLLETS", tempo: "3-1-1-1", baseSets: 5, reps: "15-20", rest: 45, why: "Marquer une pause en bas pour annuler l'élasticité." }
                    ],
                    'Vendredi': [ 
                        { name: "Dips", target: "PECS/TRI", tempo: "3-0-1-0", baseSets: 4, reps: "10", rest: 90, why: "Le 'squat du haut du corps'." },
                        { name: "Tirage H", target: "DOS", tempo: "3-0-1-1", baseSets: 4, reps: "10-12", rest: 90, why: "Travaille l'épaisseur du milieu du dos." },
                        { name: "Elev Lat", target: "EPAULES", tempo: "2-0-1-1", baseSets: 4, reps: "15", rest: 45, why: "Rappel volume pour les épaules." },
                        { name: "Curl Marteau", target: "BICEPS", tempo: "3-0-1-0", baseSets: 4, reps: "12", rest: 60, why: "Travaille le brachial et l'épaisseur du bras." }
                    ]
                },

                initApp() {
                    lucide.createIcons();
                    this.selectedDay = this.getTodayName();
                    this.generateFact();
                    
                    this.loadLocal();
                    this.calculateMacros();

                    auth.onAuthStateChanged(user => {
                        this.authReady = true;
                        if (user) {
                            this.user = user;
                            this.syncStatus = 'SYNCING...';
                            this.listenToCloud(user.uid);
                        } else {
                            this.user = null;
                            this.syncStatus = 'LOCAL ONLY';
                        }
                    });
                },

                loginWithGoogle() {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    auth.signInWithPopup(provider).catch(error => alert("Erreur connexion: " + error.message));
                },

                logout() {
                    auth.signOut().then(() => {
                        this.user = null;
                        this.resetAll(false);
                    });
                },

                listenToCloud(uid) {
                    db.collection('users').doc(uid).onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            // Simple conflict resolution: Cloud wins on init
                            this.currentWeight = data.currentWeight || this.currentWeight;
                            this.currentWeek = data.currentWeek || this.currentWeek;
                            this.xp = data.xp || this.xp;
                            this.completedSets = data.completedSets || {};
                            this.history = data.history || {};
                            this.weightHistory = data.weightHistory || [];
                            this.exerciseLogs = data.exerciseLogs || {};
                            if (data.daily) this.daily = data.daily;
                            
                            this.calculateMacros();
                            this.saveLocal();
                            this.syncStatus = 'ONLINE';
                        } else {
                            this.pushToCloud();
                        }
                    }, (error) => {
                        console.error("Sync error", error);
                        // Persistence allows us to stay "ONLINE" roughly, but let's say OFFLINE
                        this.syncStatus = 'OFFLINE (CACHE)';
                    });
                },

                // SAUVEGARDE OPTIMISEE (CORRECTION 2)
                pushToCloud(partialData = null) {
                    this.saveLocal();
                    
                    if (this.user) {
                        this.pendingChanges++;
                        this.syncStatus = 'SAVING...';
                        
                        const userRef = db.collection('users').doc(this.user.uid);
                        let promise;

                        if(partialData) {
                            // Only update specific fields
                            promise = userRef.update(partialData);
                        } else {
                            // Full update
                            promise = userRef.set({
                                currentWeight: this.currentWeight,
                                currentWeek: this.currentWeek,
                                xp: this.xp,
                                completedSets: this.completedSets,
                                history: this.history,
                                weightHistory: this.weightHistory,
                                exerciseLogs: this.exerciseLogs,
                                daily: this.daily,
                                lastUpdate: new Date().toISOString(),
                                email: this.user.email
                            }, { merge: true });
                        }
                        
                        promise.then(() => {
                            this.pendingChanges--;
                            if(this.pendingChanges === 0) this.syncStatus = 'ONLINE';
                        }).catch(e => {
                            console.error("Save failed", e);
                            this.syncStatus = 'OFFLINE (SAVED LOCAL)';
                            this.pendingChanges--;
                        });
                    }
                },

                loadLocal() {
                    const d = JSON.parse(localStorage.getItem('superman_v44'));
                    if(d) {
                        this.currentWeight = d.currentWeight;
                        this.currentWeek = d.currentWeek || 1;
                        this.xp = d.xp || 0;
                        this.weightHistory = d.weightHistory || [];
                        this.history = d.history || {};
                        this.exerciseLogs = d.exerciseLogs || {};
                        this.completedSets = d.completedSets || {};
                        if (d.daily) this.daily = d.daily;
                    }
                },

                saveLocal() {
                    localStorage.setItem('superman_v44', JSON.stringify({
                        currentWeight: this.currentWeight,
                        currentWeek: this.currentWeek,
                        xp: this.xp,
                        weightHistory: this.weightHistory,
                        history: this.history,
                        exerciseLogs: this.exerciseLogs,
                        completedSets: this.completedSets,
                        daily: this.daily
                    }));
                },

                openKeypad(target) { 
                    this.targetKey = target; 
                    this.tempWeight = target === 'bodyweight' ? this.currentWeight.toString() : (this.history[target] || "0").toString(); 
                    this.keypadOpen = true; 
                },
                
                closeKeypad() { this.keypadOpen = false; },
                
                appendDigit(digit) { 
                    if (this.tempWeight === "0" && digit !== ".") this.tempWeight = digit; 
                    else if (digit === "." && this.tempWeight.includes(".")) return; 
                    else this.tempWeight += digit; 
                },
                
                backspace() { 
                    this.tempWeight = this.tempWeight.slice(0, -1); 
                    if (this.tempWeight === "") this.tempWeight = "0"; 
                },
                
                adjustTempWeight(amount) { 
                    let val = parseFloat(this.tempWeight) || 0; 
                    val += amount; 
                    if(val < 0) val = 0; 
                    this.tempWeight = parseFloat(val.toFixed(2)).toString(); 
                },
                
                confirmWeight() { 
                    const val = parseFloat(this.tempWeight); 
                    if (this.targetKey === 'bodyweight') { 
                        this.updateWeight(val - this.currentWeight); 
                    } else { 
                        this.history[this.targetKey] = val;
                        
                        // ANTI CRASH FIX (CORRECTION 3)
                        if(!this.exerciseLogs[this.targetKey]) this.exerciseLogs[this.targetKey] = [];
                        
                        this.exerciseLogs[this.targetKey].push({ date: new Date().toLocaleDateString(), weight: val });
                        
                        // Partial save
                        this.pushToCloud({
                            [`history.${this.targetKey}`]: val,
                            [`exerciseLogs.${this.targetKey}`]: this.exerciseLogs[this.targetKey]
                        });
                    } 
                    this.closeKeypad(); 
                },
                
                // CHART RENDER FIX (CORRECTION 4)
                openExerciseInfo(ex) { 
                    this.activeExercise = ex; 
                    // Wait for modal transition
                    this.$nextTick(() => {
                        setTimeout(() => {
                            this.renderExerciseChart(ex.name);
                        }, 300); // Small delay for animation
                    });
                },

                openWeightHistory() { 
                    this.activeWeightModal = true; 
                    this.$nextTick(() => {
                        setTimeout(() => {
                            this.renderHistoryChart(); 
                        }, 300);
                    });
                },

                startTimer(sec) { 
                    if(this.timer.interval) clearInterval(this.timer.interval); 
                    this.timer.total = sec; 
                    this.timer.current = sec; 
                    this.timer.active = true; 
                    this.timer.interval = setInterval(() => { 
                        this.timer.current--; 
                        if(this.timer.current <= 0) { 
                            this.stopTimer(); 
                            if(navigator.vibrate) navigator.vibrate([200,100,200]); 
                        } 
                    }, 1000); 
                },
                adjustTimer(sec) {
                    this.timer.current += sec;
                    if(this.timer.current < 0) this.timer.current = 0;
                    if(this.timer.current > this.timer.total) this.timer.total = this.timer.current;
                },
                stopTimer() { 
                    this.timer.active = false; 
                    clearInterval(this.timer.interval); 
                },

                getCardioWeekBlock() { const w = this.currentWeek; if(w<=2) return "1-2"; if(w<=4) return "3-4"; if(w<=6) return "5-6"; if(w<=8) return "7-8"; if(w<=10) return "9-10"; if(w<=12) return "11-12"; if(w<=14) return "13-14"; return "15-16"; },
                getCardioData() {
                    const w = this.currentWeek;
                    if (w <= 2) return { focus: "ACTIVATION", summary: "40min • 4.5km/h • 3%", calories: 380, speed: "4.5 km/h", incline: "3%", duration: "40 min", details: `<ul class='list-disc pl-4 space-y-2 text-slate-300'><li><b>WARM:</b> 5min @ 3km/h 0%.</li><li><b>CORE:</b> 10min @ 4.5km/h 3% + 10min @ 5km/h 4% + 10min @ 4.5km/h 3%.</li><li><b>COOL:</b> 5min @ 3km/h 0%.</li></ul>`, science: "Mise en route du métabolisme aérobie." };
                    return { focus: "STANDARD", summary: "45min • 5km/h • 5%", calories: 450, speed: "5 km/h", incline: "5%", duration: "45 min", details: "Cardio Standard", science: "Maintenance." };
                },
                
                toggleCardio() { 
                    this.daily.cardioDone = !this.daily.cardioDone; 
                    if (this.daily.cardioDone) { 
                        this.xp += 50; 
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#f97316', '#fbbf24'] }); 
                    } else { 
                        this.xp -= 50; 
                    } 
                    this.pushToCloud({ "daily.cardioDone": this.daily.cardioDone, xp: this.xp }); 
                },

                openSupp(key) { this.activeSupp = key; }, 
                openCardioInfo() { this.activeCardio = true; }, 
                
                logManualWeight() { 
                    if(this.manualWeight) { 
                        const val = parseFloat(this.manualWeight); 
                        this.currentWeight = val; 
                        this.weightHistory.push({date: new Date().toLocaleDateString(), weight: val}); 
                        this.pushToCloud({ currentWeight: this.currentWeight, weightHistory: this.weightHistory }); 
                        this.manualWeight = ''; 
                        this.renderHistoryChart(); 
                    } 
                },
                
                generateFact() { this.randomFact = this.factsDatabase[Math.floor(Math.random() * this.factsDatabase.length)]; },
                calculateMacros() { const totalCalories = Math.round(this.currentWeight * 20); const protein = Math.round(this.currentWeight * 2.5); const fats = Math.round(this.currentWeight * 0.55); const calsFromProtFat = (protein * 4) + (fats * 9); const remainingCals = totalCalories - calsFromProtFat; const carbsHigh = Math.max(0, Math.round(remainingCals / 4)); const carbsLow = Math.max(0, Math.round((remainingCals * 0.7) / 4)); this.macros = { protein: protein, fats: fats, carbsHigh: carbsHigh, carbsLow: carbsLow, calories: totalCalories }; },
                getNutritionExplanation() { if(this.isHighCarb()) { return "Jour LOURD. On remplit le glycogène pour la force."; } else { return "Jour LÉGER. Lipolyse maximale."; } },
                changeWeek(delta) { let next = this.currentWeek + delta; if(next < 1) next = 1; if(next > 16) next = 16; this.currentWeek = next; this.pushToCloud({currentWeek: next}); },
                getSetsForWeek(ex) { let sets = ex.baseSets; if (this.currentWeek >= 5 && this.currentWeek <= 8) sets += 1; if (this.currentWeek >= 9 && this.currentWeek <= 12) sets += 2; if (this.currentWeek >= 13) sets += 1; return sets; },
                
                updateWeight(delta) { 
                    this.currentWeight = Math.round((this.currentWeight + delta) * 100) / 100; 
                    // Only push current weight, not history here to avoid spamming array
                    this.pushToCloud({ currentWeight: this.currentWeight }); 
                },
                
                getSavedWeight(name) { return this.history[name] || 0; },
                getHistory(name) { return this.history[name] ? this.history[name] + 'kg' : '-'; },
                getTodayName() { const d = new Date().getDay(); const map = {1:'Lundi', 2:'Mardi', 3:'Mercredi', 4:'Jeudi', 5:'Vendredi', 6:'Samedi', 0:'Dimanche'}; return map[d] || 'Lundi'; },
                isHighCarb() { return ['Mardi', 'Jeudi'].includes(this.selectedDay); },
                startWorkoutSession() { this.tab = 'train'; const day = this.getTodayName(); this.selectedDay = (day === 'Samedi' || day === 'Dimanche') ? 'Lundi' : day; document.getElementById('scroller').scrollTo(0,0); },
                getExercises(day) { return this.exercises[day] || []; },
                isSetDone(day, exIdx, set) { return this.completedSets[`W${this.currentWeek}-${day}-${exIdx}-${set}`]; },
                
                toggleSet(day, exIdx, set, rest) { 
                    const k = `W${this.currentWeek}-${day}-${exIdx}-${set}`; 
                    let change = {};
                    
                    if(this.completedSets[k]) { 
                        delete this.completedSets[k]; 
                        this.xp -= 10;
                        // For delete, we must save the whole object in Firestore unfortunately or use FieldValue.delete (complex)
                        // Simple way: save whole map
                        change = { completedSets: this.completedSets, xp: this.xp };
                    } else { 
                        this.completedSets[k] = true; 
                        this.xp += 20; 
                        this.startTimer(rest); 
                        if(navigator.vibrate) navigator.vibrate(50);
                        change = { [`completedSets.${k}`]: true, xp: this.xp }; // Dot notation works for updates
                    } 
                    this.pushToCloud(change); 
                },
                
                finishWorkout() { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#3b82f6', '#ef4444'] }); this.xp += 100; this.pushToCloud({xp: this.xp}); alert("SÉANCE TERMINÉE ! +100 XP"); this.tab = 'home'; },
                get xpProgress() { return (this.xp % 1000) / 10; },
                get userLevel() { return Math.floor(this.xp / 1000) + 1; },
                getSyncColor() { if(this.syncStatus === 'ONLINE') return 'bg-green-400'; if(this.syncStatus === 'OFFLINE (CACHE)') return 'bg-orange-500'; if(this.syncStatus === 'OFFLINE') return 'bg-red-500'; return 'bg-yellow-400 animate-pulse'; },
                handleSyncClick() { if(!this.user) this.loginWithGoogle(); else alert("Dernière synchro: " + new Date().toLocaleTimeString()); },
                handleProfileClick() { if(!this.user) this.loginWithGoogle(); else this.tab = 'settings'; },

                async resetAll(hard = true) { 
                    if(hard && !confirm("ATTENTION: CELA EFFACERA TOUT L'HISTORIQUE. Continuer ?")) return; 
                    
                    this.xp = 0; this.currentWeek = 1; this.currentWeight = 105.0; 
                    this.weightHistory = []; this.history = {}; this.completedSets = {}; this.exerciseLogs = {};
                    this.daily = { habits: { sleep: false, water: false, creatine: false, steps: false }, cardioDone: false }; 
                    
                    if (hard && this.user) {
                         await db.collection('users').doc(this.user.uid).delete();
                    }
                    localStorage.removeItem('superman_v44');
                    location.reload(); 
                },

                renderHistoryChart() { 
                    const ctx = document.getElementById('weightHistoryChart'); 
                    if(!ctx) return; 
                    if(this.historyChartInstance) this.historyChartInstance.destroy(); 
                    
                    const data = this.weightHistory.length ? this.weightHistory.map(x=>x.weight) : [105]; 
                    const labels = this.weightHistory.length ? this.weightHistory.map(x=>x.date) : ['Start']; 
                    
                    this.historyChartInstance = new Chart(ctx, { 
                        type: 'line', 
                        data: { 
                            labels: labels, 
                            datasets: [{ label: 'Poids', data: data, borderColor: '#3b82f6', borderWidth: 3, backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }] 
                        }, 
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { grid: { color: '#1e293b' } }, x: { display: false } } } 
                    }); 
                },
                renderExerciseChart(exName) {
                    const ctx = document.getElementById('exerciseChart');
                    if(!ctx) return;
                    if(this.exerciseChartInstance) this.exerciseChartInstance.destroy();
                    
                    const logs = this.exerciseLogs[exName] || [];
                    const data = logs.map(l => l.weight);
                    const labels = logs.map(l => l.date);
                    
                    const finalData = data.length ? data : [0];
                    const finalLabels = labels.length ? labels : ['Start'];

                    this.exerciseChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: finalLabels,
                            datasets: [{
                                label: 'Charge (kg)',
                                data: finalData,
                                borderColor: '#10b981', 
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3,
                                pointRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { grid: { color: '#1e293b' }, beginAtZero: false },
                                x: { display: false }
                            }
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>