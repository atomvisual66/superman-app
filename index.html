<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <title>SUPERMAN | OFFLINE</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Chakra+Petch:ital,wght@0,400;0,600;0,700;1,700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        
        /* CORRECTION FULL SCREEN IPHONE */
        html { 
            background-color: #020617; /* Fond noir profond pour éviter les barres blanches */
            height: 100%;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            color: #f8fafc; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            -webkit-user-select: none; 
            width: 100%;
            
            /* GESTION SAFE AREA IPHONE 15 PRO MAX */
            /* Ajoute du padding en haut pour l'heure/encoche et en bas pour la barre home */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            
            /* Utilisation de 100dvh pour la hauteur dynamique réelle */
            height: 100dvh; 
            position: fixed; 
        }

        body.modal-open { overflow: hidden !important; }
        input { user-select: text; -webkit-user-select: text; font-size: 16px !important; }
        
        #scroller { 
            height: 100%; 
            overflow-y: auto; 
            overflow-x: hidden; 
            -webkit-overflow-scrolling: touch; 
            width: 100vw; 
            max-width: 100vw;
            /* Petit padding en bas pour que le contenu ne soit pas coupé par le menu */
            padding-bottom: 8rem; 
        }

        .font-tech { font-family: 'Chakra Petch', sans-serif; }
        .font-logo { font-family: 'Russo One', sans-serif; }
        .bg-aurora { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% -20%, #0f172a 0%, #000000 80%); pointer-events: none; }
        .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6); }
        .header-solid { background-color: #020617; position: sticky; top: 0; z-index: 50; margin-left: -1rem; margin-right: -1rem; padding: 0.5rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.15); box-shadow: 0 -40px 0 40px #020617, 0 10px 30px rgba(0,0,0,0.8); }
        .hero-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; font-size: 1.5rem; color: #94a3b8; transition: transform 0.1s; }
        .hero-btn:active { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: white; transform: scale(0.9); }
        .set-btn { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .set-btn.done { background: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 0 15px rgba(37, 99, 235, 0.6); transform: scale(1.1); }
        .logo-container { text-align: center; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .logo-top { font-family: 'Chakra Petch', sans-serif; font-size: 0.7rem; letter-spacing: 0.4em; color: #94a3b8; font-weight: 700; margin-bottom: -3px; text-transform: uppercase; }
        .logo-main { font-family: 'Russo One', sans-serif; font-size: 2.2rem; line-height: 1; background: linear-gradient(180deg, #ffffff 20%, #3b82f6 90%); -webkit-background-clip: text; color: transparent; text-shadow: 0 0 20px rgba(37, 99, 235, 0.6); letter-spacing: 1px; text-transform: uppercase; }
        .modal-enter { transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
        .modal-enter-start { opacity: 0; transform: scale(0.95); }
        .modal-enter-end { opacity: 1; transform: scale(1); }
        .cardio-gradient { background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(234, 88, 12, 0.05)); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .weight-display-btn { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 6px 12px; font-family: 'Russo One', sans-serif; color: white; font-size: 1.2rem; min-width: 80px; text-align: center; transition: all 0.2s; }
        .weight-display-btn:active { transform: scale(0.95); border-color: #3b82f6; background: rgba(59, 130, 246, 0.2); }
        .keypad-btn { @apply flex items-center justify-center rounded-xl bg-slate-800 border border-white/10 text-xl font-bold text-white transition active:scale-95 active:bg-slate-700; height: 50px; }
        .keypad-quick { @apply bg-slate-700/50 text-xs font-mono text-blue-300 border-blue-500/20 h-10 rounded-lg; }
    </style>
</head>
<body x-data="app()" x-init="initApp()" class="flex flex-col text-slate-200" :class="{ 'modal-open': isModalOpen }">

    <div class="bg-aurora"></div>
    
    <div class="absolute left-4 z-50 flex items-center gap-2 bg-slate-900/80 px-2 py-1 rounded-full border border-white/5 backdrop-blur-md" style="top: calc(env(safe-area-inset-top) + 1rem);">
        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
        <span class="text-[9px] font-mono uppercase tracking-widest text-slate-300">LOCAL MEMORY</span>
    </div>

    <div class="logo-container">
        <div class="logo-top">ROAD TO</div>
        <div class="logo-main">SUPERMAN</div>
    </div>

    <header class="flex-none px-6 pb-2 pt-0 flex justify-between items-center z-20">
        <div class="relative w-full">
            <div class="flex justify-between text-[10px] uppercase font-bold mb-1 text-blue-300 font-tech">
                <span>SEMAINE <span x-text="currentWeek"></span> • LVL <span x-text="userLevel"></span></span>
                <span x-text="Math.floor(xp) + ' XP'"></span>
            </div>
            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden border border-white/10 shadow-inner">
                <div class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-1000" :style="`width: ${xpProgress}%`"></div>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-3 pb-32 relative scroll-smooth" id="scroller">
        
        <div x-show="tab === 'home'" class="space-y-4" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95">
            
            <div class="glass-panel rounded-3xl p-5 relative overflow-hidden group text-center border border-blue-500/20">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-blue-600/20 rounded-full blur-[80px] -mt-20"></div>
                <div class="flex justify-between items-center mb-3 relative z-10">
                     <p class="text-[10px] text-blue-300 font-bold uppercase tracking-[0.2em] font-tech text-center w-full">Objectif : <span x-text="(currentWeight - 25).toFixed(1)"></span> KG</p>
                     <button @click="openWeightHistory()" class="absolute right-0 top-0 p-2 text-slate-400 hover:text-white bg-white/5 rounded-lg hover:bg-white/10 transition active:scale-90"><i data-lucide="clipboard-list" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center justify-center gap-4 relative z-10 mb-3">
                    <button @click="updateWeight(-0.1)" class="hero-btn hover:text-white hover:border-blue-500"><i data-lucide="minus" class="w-5 h-5"></i></button>
                    <div class="flex flex-col items-center w-40 cursor-pointer active:scale-95 transition-transform" @click="openKeypad('bodyweight')">
                        <span class="text-5xl font-logo text-white tabular-nums tracking-tight leading-none drop-shadow-2xl" x-text="currentWeight.toFixed(1)"></span>
                        <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Kilogrammes</span>
                    </div>
                    <button @click="updateWeight(0.1)" class="hero-btn hover:text-white hover:border-blue-500"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </div>
                <div class="inline-block bg-black/40 px-3 py-1 rounded-full border border-white/5 backdrop-blur-sm">
                    <span class="text-[10px] font-mono text-red-400 font-bold">Déficit : <span x-text="macros.calories"></span> kcal/j</span>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-4">
                <div class="flex items-center gap-2 mb-3 border-b border-white/5 pb-2">
                    <i data-lucide="flask-conical" class="w-4 h-4 text-slate-400"></i>
                    <h3 class="text-xs font-bold text-slate-300 uppercase font-tech tracking-wider">Bio-Hacking Stack</h3>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <template x-for="(supp, key) in supplementsInfo">
                        <button @click="openSupp(key)" class="bg-slate-900/50 border border-white/5 rounded-xl p-2 flex flex-col items-center gap-1 transition active:scale-95 hover:border-white/20 group shadow-sm">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center transition-all shadow-lg" :class="supp.bg" x-html="supp.svg"></div>
                            <span class="text-[8px] font-bold uppercase text-slate-500 group-hover:text-white transition-colors" x-text="supp.short"></span>
                        </button>
                    </template>
                </div>
            </div>

            <div @click="activeNutri = true" class="glass-panel rounded-2xl p-4 border-l-4 relative overflow-hidden cursor-pointer hover:border-white/20 transition active:scale-[0.99]" :class="isHighCarb() ? 'border-l-green-500' : 'border-l-yellow-500'">
                <div class="absolute right-0 top-0 opacity-10 p-3"><i :data-lucide="isHighCarb() ? 'zap' : 'flame'" class="w-14 h-14"></i></div>
                <div class="relative z-10">
                     <div class="flex justify-between items-center mb-2">
                        <div>
                            <div class="text-[9px] font-bold text-slate-400 uppercase font-tech flex items-center gap-1">Cycle Métabolique <i data-lucide="info" class="w-3 h-3"></i></div>
                            <div class="text-lg font-bold font-logo" :class="isHighCarb() ? 'text-green-400' : 'text-yellow-400'" x-text="isHighCarb() ? 'HIGH CARB' : 'LOW CARB'"></div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-white font-logo tracking-tighter" x-text="macros.calories"></div>
                            <div class="text-[8px] text-slate-500 uppercase tracking-widest">Kcal Target</div>
                        </div>
                     </div>
                     <div class="space-y-1.5">
                        <div class="flex items-center gap-2 text-[9px] font-bold text-slate-400">
                            <span class="w-8 text-blue-400">PROT</span>
                            <div class="flex-1 h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-blue-500 rounded-full" style="width: 50%"></div></div>
                            <span class="text-white w-8 text-right" x-text="macros.protein"></span>
                        </div>
                        <div class="flex items-center gap-2 text-[9px] font-bold text-slate-400">
                            <span class="w-8 text-yellow-400">LIP</span>
                            <div class="flex-1 h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-yellow-500 rounded-full" style="width: 30%"></div></div>
                            <span class="text-white w-8 text-right" x-text="macros.fats"></span>
                        </div>
                        <div class="flex items-center gap-2 text-[9px] font-bold text-slate-400">
                            <span class="w-8 text-green-400">GLU</span>
                            <div class="flex-1 h-1.5 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-green-500 rounded-full" :style="`width: ${isHighCarb() ? '60%' : '20%'}`"></div></div>
                            <span class="text-white w-8 text-right" x-text="isHighCarb() ? macros.carbsHigh : macros.carbsLow"></span>
                        </div>
                     </div>
                </div>
            </div>

            <div @click="openCardioInfo()" class="glass-panel p-4 rounded-2xl border border-orange-500/30 cardio-gradient relative overflow-hidden cursor-pointer hover:border-orange-500/50 transition active:scale-[0.99] group">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-orange-500/10 rounded-full blur-xl"></div>
                <div class="flex items-center gap-3 mb-3 relative z-10 border-b border-orange-500/20 pb-2">
                    <div class="w-8 h-8 rounded-lg bg-orange-500/20 flex items-center justify-center text-orange-400 border border-orange-500/30">
                        <i data-lucide="flame" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-orange-400 text-xs uppercase font-tech flex items-center gap-2">
                            Cardio <span x-text="getCardioWeekBlock()"></span> <i data-lucide="info" class="w-3 h-3 text-orange-400/50"></i>
                        </h3>
                        <p class="text-[9px] text-slate-400">Brûleur de Graisses • Actif</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mb-3">
                     <div class="bg-orange-900/30 p-1.5 rounded-lg border border-orange-500/20 text-center">
                         <div class="text-[8px] text-orange-300 uppercase mb-0.5">Durée</div>
                         <div class="text-xs font-bold text-white font-mono" x-text="getCardioData().duration"></div>
                     </div>
                     <div class="bg-orange-900/30 p-1.5 rounded-lg border border-orange-500/20 text-center">
                         <div class="text-[8px] text-orange-300 uppercase mb-0.5">Vitesse</div>
                         <div class="text-xs font-bold text-white font-mono flex justify-center items-center gap-1"><i data-lucide="zap" class="w-2 h-2"></i> <span x-text="getCardioData().speed"></span></div>
                     </div>
                     <div class="bg-orange-900/30 p-1.5 rounded-lg border border-orange-500/20 text-center">
                         <div class="text-[8px] text-orange-300 uppercase mb-0.5">Pente</div>
                         <div class="text-xs font-bold text-white font-mono flex justify-center items-center gap-1"><i data-lucide="mountain" class="w-2 h-2"></i> <span x-text="getCardioData().incline"></span></div>
                     </div>
                </div>

                <div @click.stop class="flex items-center gap-3 bg-orange-500/10 p-2.5 rounded-lg border border-orange-500/20 hover:bg-orange-500/20 transition cursor-pointer" @click="toggleCardio()">
                    <div class="w-4 h-4 rounded border border-orange-500 bg-slate-900 flex items-center justify-center transition-colors" :class="daily.cardioDone ? 'bg-orange-500' : ''">
                        <i data-lucide="check" class="w-3 h-3 text-white" x-show="daily.cardioDone"></i>
                    </div>
                    <span class="text-[9px] font-bold text-orange-200 uppercase tracking-wide" x-text="daily.cardioDone ? 'Mission Validée' : 'Valider Mission'"></span>
                </div>
            </div>
            <div class="h-20"></div>
        </div>

        <div x-show="tab === 'train'" class="space-y-4" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-x-10 opacity-0">
            
            <div class="header-solid">
                <div class="mb-2 flex items-center gap-2">
                    <span class="text-[8px] font-bold text-slate-500 uppercase tracking-wider w-8">Prog.</span>
                    <div class="flex-1 h-1 bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-green-500 transition-all duration-500" :style="`width: ${sessionProgress}%`"></div>
                    </div>
                    <span class="text-[8px] font-bold text-green-400 w-6 text-right" x-text="sessionProgress + '%'"></span>
                </div>

                <div class="flex justify-between items-center mb-2 bg-white/5 p-1 rounded-lg mx-1 border border-white/10">
                    <button @click="changeWeek(-1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/10 rounded-lg transition active:scale-90"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <div class="text-center">
                         <span class="text-[9px] text-slate-500 uppercase font-bold tracking-widest block">Planning</span>
                        <span class="text-xs font-bold text-white font-tech uppercase">Semaine <span class="text-blue-400 text-sm" x-text="currentWeek"></span></span>
                    </div>
                    <button @click="changeWeek(1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/10 rounded-lg transition active:scale-90"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
                <div class="flex gap-1.5 overflow-x-auto hide-scrollbar pb-1 justify-center">
                    <template x-for="day in splitOrder">
                        <button @click="selectedDay = day" class="px-3 py-2 rounded-lg text-[9px] font-bold uppercase border transition-all whitespace-nowrap font-tech"
                        :class="selectedDay === day ? 'bg-blue-600 border-blue-500 text-white shadow-lg' : 'bg-slate-800/50 border-slate-700 text-slate-500'">
                            <span x-text="day"></span>
                        </button>
                    </template>
                </div>
            </div>

            <div class="space-y-3">
                <template x-for="(ex, index) in getExercises(selectedDay)" :key="index">
                    <div class="glass-panel rounded-2xl overflow-hidden border-l-4 relative transition-all duration-300" :class="ex.isPopeye ? 'border-l-green-500' : 'border-l-blue-500'">
                        <div x-show="ex.isPopeye" class="absolute top-0 right-0 bg-green-500/20 text-green-400 text-[8px] px-2 py-0.5 rounded-bl-lg font-bold font-tech">POPEYE</div>
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1 pr-2">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <h4 @click="openExerciseInfo(ex)" class="font-bold text-white text-sm font-tech border-b border-dashed border-slate-600 cursor-help hover:text-blue-400 transition" x-text="ex.name"></h4>
                                        <button @click.stop="openExerciseInfo(ex)" class="text-[8px] bg-blue-900/40 text-blue-300 border border-blue-500/30 px-1.5 py-0.5 rounded uppercase font-bold hover:bg-blue-800/50 transition">
                                            <i data-lucide="brain-circuit" class="w-2 h-2 inline mr-1"></i>Analyse
                                        </button>
                                    </div>
                                    <div class="flex gap-2 mt-2 items-center flex-wrap">
                                        <div class="flex items-center gap-1 text-[9px] bg-blue-900/30 text-blue-300 px-1.5 py-0.5 rounded-lg border border-blue-500/30 font-mono">
                                            <i data-lucide="timer" class="w-3 h-3"></i>
                                            <span x-text="ex.tempo"></span>
                                        </div>
                                        <div class="text-[9px] bg-white/5 px-2 py-0.5 rounded-lg text-slate-300 font-bold" x-text="ex.reps + ' Reps'"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between bg-black/40 p-1.5 rounded-lg mb-3 border border-white/5">
                                <div class="pl-2 text-[9px] text-slate-500 font-mono uppercase">Last: <span x-text="getHistory(ex.name)" class="text-slate-300"></span></div>
                                <button @click="openKeypad(ex.name)" class="weight-display-btn active:scale-95">
                                    <span x-text="getSavedWeight(ex.name) + ' kg'"></span>
                                </button>
                            </div>
                            <div class="flex flex-wrap gap-2 justify-center">
                                <template x-for="set in getSetsForWeek(ex)">
                                    <button @click="toggleSet(selectedDay, index, set, ex.rest)"
                                        class="w-10 h-9 rounded-lg border border-slate-700 flex items-center justify-center font-bold text-sm set-btn bg-slate-800/50 text-slate-500 font-mono"
                                        :class="isSetDone(selectedDay, index, set) ? 'done' : ''">
                                        <span x-text="set"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
                <div class="h-32"></div>
                <button @click="finishWorkout()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl text-white font-logo text-base uppercase tracking-widest shadow-xl shadow-blue-900/40 mb-10 border-t border-white/20 active:scale-95 transition">
                    Terminer Mission
                </button>
            </div>
        </div>

        <div x-show="activeWeightModal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak>
            <div class="glass-panel border border-white/10 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl max-h-[80vh] flex flex-col" @click.away="activeWeightModal = false">
                <button @click="activeWeightModal = false" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <h3 class="text-xl font-logo text-white mb-4 text-center">Historique Poids</h3>
                <div class="h-40 w-full mb-4 bg-slate-900/50 rounded-xl p-2 border border-white/5 relative"><canvas id="weightHistoryChart"></canvas></div>
                <div class="flex-1 overflow-y-auto space-y-2">
                    <template x-for="log in weightHistory.slice().reverse()">
                        <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg text-xs border border-white/5"><span class="text-slate-400" x-text="log.date"></span><span class="text-white font-bold font-mono" x-text="log.weight + ' kg'"></span></div>
                    </template>
                </div>
            </div>
        </div>

        <div x-show="activeNutri" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeNutri = false"><div class="glass-panel border border-green-500/30 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl"><button @click="activeNutri = false" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button><div class="text-center mb-6"><div class="w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center mx-auto mb-3 border border-green-500/20"><i :data-lucide="isHighCarb() ? 'zap' : 'leaf'" class="w-8 h-8 text-green-400"></i></div><h3 class="text-2xl font-logo text-white mb-1" :class="isHighCarb() ? 'text-green-400' : 'text-yellow-400'" x-text="isHighCarb() ? 'HIGH CARB DAY' : 'LOW CARB DAY'"></h3></div><div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 mb-4"><h4 class="text-[10px] font-bold text-slate-300 uppercase mb-2">Pourquoi ce cycle ?</h4><p class="text-sm text-slate-300 leading-relaxed text-justify" x-text="getNutritionExplanation()"></p></div></div></div>
        
        <div x-show="activeCardio" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeCardio = false"><div class="glass-panel border border-orange-500/30 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl max-h-[80vh] overflow-y-auto"><button @click="activeCardio = false" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button><div class="text-center mb-6"><div class="w-14 h-14 rounded-full bg-orange-500/10 flex items-center justify-center mx-auto mb-3 border border-orange-500/20"><i data-lucide="flame" class="w-7 h-7 text-orange-500"></i></div><h3 class="text-2xl font-logo text-white mb-1">Semaine <span x-text="currentWeek"></span></h3><span class="text-[10px] bg-orange-500/20 text-orange-300 px-3 py-1 rounded-full border border-orange-500/30 font-mono uppercase tracking-wider" x-text="getCardioData().focus"></span></div><div class="space-y-4"><div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5"><h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Détails de la séance</h4><div class="text-sm text-white font-mono leading-relaxed space-y-2" x-html="getCardioData().details"></div><div class="mt-3 pt-3 border-t border-white/5 text-xs text-orange-300 flex justify-between"><span>Calories Estimées</span><span class="font-bold" x-text="getCardioData().calories + ' kcal'"></span></div></div><div class="bg-orange-900/10 p-4 rounded-2xl border border-orange-500/20"><h4 class="text-[10px] font-bold text-orange-400 uppercase mb-2 flex items-center gap-2"><i data-lucide="microscope" class="w-3 h-3"></i> Science</h4><p class="text-sm text-slate-200 leading-relaxed text-justify" x-text="getCardioData().science"></p></div></div></div></div>
        
        <div x-show="activeExercise !== null" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeExercise = null">
            <div class="glass-panel border border-blue-500/30 rounded-3xl p-6 w-full max-w-sm relative shadow-2xl max-h-[85vh] overflow-y-auto flex flex-col">
                <button @click="activeExercise = null" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-logo text-white mb-2 leading-tight" x-text="activeExercise?.name"></h3>
                    <span class="text-[10px] bg-blue-500/20 text-blue-300 px-3 py-1 rounded-full border border-blue-500/30 font-mono uppercase tracking-wider" x-text="'Tempo: ' + activeExercise?.tempo"></span>
                </div>
                <div class="bg-slate-900/80 p-2 rounded-xl border border-white/5 mb-4"><h4 class="text-[9px] font-bold text-slate-400 uppercase mb-1 ml-2">Progression de Force</h4><div class="h-32 w-full relative"><canvas id="exerciseChart"></canvas></div></div>
                <div class="bg-blue-900/10 p-5 rounded-2xl border border-blue-500/20"><h4 class="text-[10px] font-bold text-blue-400 uppercase mb-2 flex items-center gap-2"><i data-lucide="microscope" class="w-3 h-3"></i> Analyse Biomécanique</h4><p class="text-sm text-slate-200 leading-relaxed text-justify font-medium" x-text="activeExercise?.why"></p></div>
            </div>
        </div>

        <div x-show="activeSupp !== null" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-md p-6" x-transition:enter="modal-enter" x-transition:enter-start="modal-enter-start" x-transition:enter-end="modal-enter-end" x-cloak @click.away="activeSupp = null"><div class="glass-panel border border-white/10 rounded-3xl p-6 w-full max-w-sm relative overflow-hidden shadow-2xl"><div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r" :class="supplementsInfo[activeSupp]?.gradient"></div><button @click="activeSupp = null" class="absolute top-5 right-5 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button><div class="text-center mb-6 mt-2"><div class="w-16 h-16 rounded-full flex items-center justify-center mb-4 mx-auto border-2 shadow-[0_0_20px_rgba(255,255,255,0.1)]" :class="supplementsInfo[activeSupp]?.color + ' ' + supplementsInfo[activeSupp]?.bg + ' border-white/10'" x-html="supplementsInfo[activeSupp]?.svg"></div><h3 class="text-2xl font-logo text-white mb-1" x-text="supplementsInfo[activeSupp]?.title"></h3></div><div class="space-y-4"><div class="bg-white/5 p-4 rounded-xl border border-white/10"><h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Mécanisme d'action</h4><p class="text-sm text-slate-200 leading-relaxed text-justify" x-text="supplementsInfo[activeSupp]?.text"></p></div><div class="flex items-center gap-3 bg-slate-900/50 p-3 rounded-xl border border-white/5"><i data-lucide="clock" class="w-5 h-5 text-slate-400"></i><div><span class="text-[10px] font-bold text-slate-500 uppercase block">Protocole</span><span class="text-xs text-white font-mono font-bold" x-text="supplementsInfo[activeSupp]?.dose"></span></div></div></div></div></div>

        <div x-show="keypadOpen" class="fixed inset-0 z-[90] flex items-end justify-center bg-black/80 backdrop-blur-sm" x-transition:enter="modal-enter" x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0" x-cloak @click.self="closeKeypad()"><div class="glass-panel w-full max-w-md rounded-t-3xl p-6 border-t border-white/20 bg-[#0f172a] shadow-2xl"><div class="flex justify-between items-center mb-6"><span class="text-xs text-slate-400 font-bold uppercase tracking-widest">Saisir la Charge</span><button @click="closeKeypad()" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="text-center mb-8"><span class="text-6xl font-logo text-white" x-text="tempWeight"></span><span class="text-xl text-blue-500 font-bold ml-2">KG</span></div><div class="grid grid-cols-4 gap-3 mb-6"><button @click="adjustTempWeight(10)" class="keypad-quick">+10</button><button @click="adjustTempWeight(5)" class="keypad-quick">+5</button><button @click="adjustTempWeight(2.5)" class="keypad-quick">+2.5</button><button @click="adjustTempWeight(1.25)" class="keypad-quick">+1.25</button><button @click="adjustTempWeight(-10)" class="keypad-quick text-red-400 border-red-500/20">-10</button><button @click="adjustTempWeight(-5)" class="keypad-quick text-red-400 border-red-500/20">-5</button><button @click="adjustTempWeight(-2.5)" class="keypad-quick text-red-400 border-red-500/20">-2.5</button><button @click="adjustTempWeight(-1.25)" class="keypad-quick text-red-400 border-red-500/20">-1.25</button></div><div class="grid grid-cols-3 gap-3 mb-4"><button @click="appendDigit('1')" class="keypad-btn">1</button><button @click="appendDigit('2')" class="keypad-btn">2</button><button @click="appendDigit('3')" class="keypad-btn">3</button><button @click="appendDigit('4')" class="keypad-btn">4</button><button @click="appendDigit('5')" class="keypad-btn">5</button><button @click="appendDigit('6')" class="keypad-btn">6</button><button @click="appendDigit('7')" class="keypad-btn">7</button><button @click="appendDigit('8')" class="keypad-btn">8</button><button @click="appendDigit('9')" class="keypad-btn">9</button><button @click="appendDigit('.')" class="keypad-btn">.</button><button @click="appendDigit('0')" class="keypad-btn">0</button><button @click="backspace()" class="keypad-btn text-red-400"><i data-lucide="delete" class="w-6 h-6"></i></button></div><button @click="confirmWeight()" class="w-full py-4 bg-blue-600 rounded-2xl text-white font-logo text-xl uppercase tracking-widest shadow-lg shadow-blue-900/50 active:scale-95 transition">VALIDER</button></div></div>

        <div x-show="tab === 'settings'" class="space-y-4">
             <div class="glass-panel p-5 rounded-2xl border border-green-500/30 flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 animate-pulse"><i data-lucide="save" class="w-5 h-5"></i></div>
                <div>
                    <h2 class="font-bold text-white text-sm font-tech uppercase">Mode Local Activé</h2>
                    <p class="text-xs text-slate-400 mt-1">Vos données sont sauvegardées dans ce téléphone.</p>
                </div>
             </div>
             <button @click="resetAll()" class="w-full py-4 text-red-500 text-xs border border-red-900/30 rounded-xl bg-red-900/10 font-bold uppercase hover:bg-red-900/20 transition active:scale-95">Tout Effacer (Reset)</button>
        </div>

    </main>

    <div x-show="timer.active" class="fixed bottom-0 inset-x-0 bg-[#020617] border-t border-blue-500/50 p-6 pb-8 z-50 rounded-t-[2.5rem] shadow-[0_-10px_60px_rgba(0,0,0,1)]" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-y-full">
        <div class="flex justify-between items-center mb-4 px-2">
            <span class="text-blue-400 text-xs font-bold uppercase animate-pulse font-tech tracking-widest">Récupération</span>
            <div class="flex gap-2">
                <button @click="adjustTimer(30)" class="text-xs bg-slate-800 px-2 py-1 rounded border border-white/10 text-white font-mono">+30s</button>
                <button @click="adjustTimer(-30)" class="text-xs bg-slate-800 px-2 py-1 rounded border border-white/10 text-white font-mono">-30s</button>
                <button @click="stopTimer()" class="text-slate-500 hover:text-white p-1"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
            </div>
        </div>
        <div class="text-center relative my-2">
            <span class="text-7xl font-logo font-bold text-white tabular-nums tracking-tighter drop-shadow-2xl" x-text="timer.current"></span>
            <span class="text-sm text-slate-500 absolute top-4 right-12 font-bold">SEC</span>
        </div>
        <div class="h-2 bg-slate-800 mt-6 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-1000 ease-linear" :style="`width: ${(timer.current/timer.total)*100}%`"></div>
        </div>
    </div>

    <div x-show="!timer.active && !keypadOpen" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-40 w-full max-w-xs" style="padding-bottom: env(safe-area-inset-bottom);">
        <div class="glass-panel rounded-full px-6 py-3 flex items-center justify-between gap-4 shadow-2xl border border-white/10 bg-black/60 backdrop-blur-xl ring-1 ring-white/5">
            <button @click="tab = 'home'" :class="tab==='home'?'text-blue-400 scale-110':'text-slate-500 hover:text-slate-300'" class="transition duration-300 active:scale-90"><i data-lucide="layout-grid" class="w-5 h-5"></i></button>
            <button @click="startWorkoutSession()" class="relative -top-5 group">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-blue-700 to-blue-500 flex items-center justify-center shadow-[0_0_20px_rgba(37,99,235,0.6)] border-2 border-white/10 text-white transform transition duration-300 group-active:scale-90 rotate-45 group-hover:rotate-0">
                    <i data-lucide="dumbbell" class="w-6 h-6 -rotate-45 group-hover:rotate-0 transition duration-300"></i>
                </div>
            </button>
            <button @click="tab = 'settings'" :class="tab==='settings'?'text-blue-400 scale-110':'text-slate-500 hover:text-slate-300'" class="transition duration-300 active:scale-90"><i data-lucide="settings" class="w-5 h-5"></i></button>
        </div>
    </div>

    <script>
        function app() {
            return {
                tab: 'home',
                currentWeight: 105.0,
                currentWeek: 1,
                selectedDay: 'Lundi',
                xp: 0,
                weightHistory: [],
                completedSets: {},
                history: {},      
                exerciseLogs: {}, 
                daily: { habits: { sleep: false, water: false, creatine: false, steps: false }, cardioDone: false },
                activeSupp: null, activeExercise: null, activeCardio: false, activeNutri: false, activeWeightModal: false, keypadOpen: false, tempWeight: "0", targetKey: null, 
                randomFact: { text: "Loading...", source: "" },
                get isModalOpen() { return this.activeExercise || this.activeWeightModal || this.activeCardio || this.activeNutri || this.activeSupp || this.keypadOpen; },
                timer: { active: false, current: 0, total: 0, interval: null },
                historyChartInstance: null, exerciseChartInstance: null,

                macros: { protein: 0, fats: 0, carbsHigh: 0, carbsLow: 0, calories: 0 },
                supplementsInfo: {
                    creatine: { short: "Créatine", icon: "zap", title: "Créatine Monohydrate", dose: "5g / jour", text: "Booste l'ATP pour +15% de force.", color: "text-purple-400", bg: "bg-purple-500/10", gradient: "from-purple-500 to-indigo-500", svg: `<svg class="w-5 h-5 text-purple-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>` },
                    omega3: { short: "Omega 3", icon: "fish", title: "Omega 3", dose: "2g / jour", text: "Anti-inflammatoire, aide à la perte de gras.", color: "text-yellow-400", bg: "bg-yellow-500/10", gradient: "from-yellow-400 to-orange-500", svg: `<svg class="w-5 h-5 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 12c.94-3.46 4.94-6 8.5-6 3.56 0 6.06 2.54 7 6-.94 3.47-3.44 6-7 6s-7.56-2.53-8.5-6Z"/><path d="M18 12v.5"/></svg>` },
                    magnesium: { short: "Magnésium", icon: "moon", title: "Magnésium Bisglycinate", dose: "300mg soir", text: "Sommeil profond et récupération nerveuse.", color: "text-blue-400", bg: "bg-blue-500/10", gradient: "from-blue-400 to-cyan-500", svg: `<svg class="w-5 h-5 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>` },
                    protein: { short: "Whey", icon: "milk", title: "Whey Isolate", dose: "40g Post", text: "Récupération musculaire immédiate.", color: "text-slate-200", bg: "bg-slate-700/30", gradient: "from-slate-400 to-slate-600", svg: `<svg class="w-5 h-5 text-slate-200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2h8"/><path d="M9 2v2.79c0 .42.19.82.53 1.08l4.94 3.85a2.78 2.78 0 0 1 1.08 2.2v6.08a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-6.08c0-.9.38-1.76 1.08-2.2l4.94-3.85A1.78 1.78 0 0 0 12.53 4.8V2"/></svg>` }
                },
                factsDatabase: [{ text: "Discipline > Motivation.", source: "Jocko" }, { text: "Marche = Perte de gras sans fatigue.", source: "BioLayne" }, { text: "Le muscle se construit au lit, pas à la salle.", source: "Science" }],
                splitOrder: ['Lundi', 'Mardi', 'Jeudi', 'Vendredi', 'Samedi'],
                
                // NOUVEAU : STRUCTURE PAR PHASES (4 Blocs de 4 Semaines)
                allPhases: {
                    // PHASE 1 : FORCE MAXIMALE (Semaines 1-4)
                    phase1: {
                        'Lundi': [
                            { name: "Squat Barre", target: "CUISSES", tempo: "3-1-X-0", baseSets: 5, reps: "5-6", rest: 180, why: "Force brute, amplitude max." },
                            { name: "Presse Hack 45°", target: "CUISSES", tempo: "3-0-1-1", baseSets: 4, reps: "6-8", rest: 120, why: "Sécurité colonne, force lockout." },
                            { name: "Fentes Marchées", target: "FESSIERS", tempo: "3-0-1-0", baseSets: 3, reps: "6-8", rest: 120, why: "Unilatéral lourd." },
                            { name: "Mollets Debout", target: "MOLLETS", tempo: "3-1-1-1", baseSets: 4, reps: "8-10", rest: 60, why: "Force mollets." },
                            { name: "Ab Wheel", target: "ABS", tempo: "3-0-1-0", baseSets: 3, reps: "8-10", rest: 60, why: "Core force." }
                        ],
                        'Mardi': [
                            { name: "Dev. Couché Barre", target: "PECS", tempo: "3-1-1-0", baseSets: 4, reps: "5-6", rest: 180, why: "Force brute pecs." },
                            { name: "Rowing T-Bar", target: "DOS EPAIS", tempo: "3-1-X-0", baseSets: 4, reps: "5-6", rest: 180, why: "Épaisseur DOS, force." },
                            { name: "Dev. Militaire Debout", target: "ÉPAULES", tempo: "3-0-1-0", baseSets: 3, reps: "6-8", rest: 120, why: "Stabilité, force épaules." },
                            { name: "Dips", target: "PECS/TRI", tempo: "3-0-1-0", baseSets: 3, reps: "6-8", rest: 120, why: "Masse triceps." },
                            { name: "Tirage Pronation Lourd", target: "DOS LARGE", tempo: "3-0-1-0", baseSets: 3, reps: "6-8", rest: 120, why: "Largeur force." }
                        ],
                        'Jeudi': [
                            { name: "Soulevé de Terre Classique", target: "ISCHIOS", tempo: "3-1-X-0", baseSets: 5, reps: "3-5", rest: 180, why: "Le ROI, force maximale." },
                            { name: "Leg Curl Assis Lourd", target: "ISCHIOS", tempo: "3-0-1-0", baseSets: 4, reps: "6-8", rest: 120, why: "Isolation postérieur." },
                            { name: "Fentes Bulgares", target: "FESSIERS", tempo: "3-0-1-0", baseSets: 3, reps: "6-8", rest: 120, why: "Unilatéral glute." },
                            { name: "Hip Thrust Lourd", target: "FESSIERS", tempo: "3-0-1-0", baseSets: 3, reps: "8-10", rest: 120, why: "Force glute/quad." },
                            { name: "Mollets Assis", target: "MOLLETS", tempo: "3-1-1-1", baseSets: 4, reps: "10-12", rest: 60, why: "Soleus force." }
                        ],
                        'Vendredi': [
                            { name: "Dev. Incliné Barre", target: "HAUT PECS", tempo: "3-0-1-0", baseSets: 4, reps: "6-8", rest: 120, why: "Haut pecs force." },
                            { name: "Elev. Latérales Strictes", target: "LARGEUR", tempo: "2-0-1-1", baseSets: 4, reps: "8-10", rest: 90, why: "Delts force." },
                            { name: "Dips Lestés", target: "PECS/TRI", tempo: "3-0-1-0", baseSets: 3, reps: "6-8", rest: 120, why: "Force triceps/pecs." },
                            { name: "Ext Triceps Barre", target: "TRICEPS", tempo: "3-0-1-0", baseSets: 4, reps: "6-8", rest: 90, why: "Triceps force." },
                            { name: "Shoulder Press Machine", target: "ÉPAULES", tempo: "3-0-1-0", baseSets: 3, reps: "8-10", rest: 90, why: "Force full shoulder." }
                        ],
                        'Samedi': [
                            { name: "Tractions Lestées", target: "DOS LARGE", tempo: "3-0-1-0", baseSets: 4, reps: "5-8", rest: 120, why: "Force dorsale." },
                            { name: "Rowing Unilatéral Lourd", target: "DOS EPAIS", tempo: "3-0-1-0", baseSets: 4, reps: "6-8", rest: 120, why: "Unilat dos épais." },
                            { name: "Face Pull", target: "POSTURE", tempo: "2-1-1-1", baseSets: 4, reps: "12-15", rest: 60, why: "Santé épaule." },
                            { name: "Curl Barre Lourd", target: "BICEPS", tempo: "3-0-1-0", baseSets: 4, reps: "6-8", rest: 120, why: "Force biceps." },
                            { name: "Curl Marteau", target: "BRACHIAL", tempo: "3-0-1-0", baseSets: 3, reps: "8-10", rest: 90, why: "Brachial/biceps." }
                        ]
                    },
                    // PHASE 2 : HYPERTROPHIE SARCOPLASME (Semaines 5-8)
                    phase2: {
                        'Lundi': [
                            { name: "Leg Press 45°", target: "CUISSES", tempo: "2-0-1-1", baseSets: 4, reps: "8-10", rest: 90, why: "Explosif, hypertrophie." },
                            { name: "Squat Bulgare", target: "CUISSES", tempo: "3-0-1-0", baseSets: 3, reps: "8-10", rest: 90, why: "Unilatéral hyper." },
                            { name: "Leg Extension", target: "QUADS", tempo: "2-0-1-1", baseSets: 4, reps: "12-15", rest: 60, why: "Isolation hyper." },
                            { name: "Marche Fermier", target: "GRIP", tempo: "Static", baseSets: 4, reps: "45s", rest: 90, why: "Grip + métabolisme." },
                            { name: "Abs Roller", target: "ABS", tempo: "2-0-1-0", baseSets: 3, reps: "12-15", rest: 60, why: "Hyper abdos." }
                        ],
                        'Mardi': [
                            { name: "Dev. Incliné Machine", target: "HAUT PECS", tempo: "2-0-1-1", baseSets: 4, reps: "10-12", rest: 90, why: "Hyper haut pecs." },
                            { name: "Rowing Machine", target: "DOS EPAIS", tempo: "2-0-1-1", baseSets: 4, reps: "10-12", rest: 90, why: "Hyper machine." },
                            { name: "Dev. Épaules Machine", target: "ÉPAULES", tempo: "2-0-1-1", baseSets: 3, reps: "10-12", rest: 90, why: "Hyper full shoulder." },
                            { name: "Fly Pec Machine", target: "PECS", tempo: "2-0-1-1", baseSets: 3, reps: "12-15", rest: 60, why: "Isolation pecs hyper." },
                            { name: "Tirage Long", target: "DOS LARGE", tempo: "2-0-1-1", baseSets: 3, reps: "10-12", rest: 90, why: "Hyper largeur." }
                        ],
                        'Jeudi': [
                            { name: "Soulevé de Terre Sumo", target: "ISCHIOS", tempo: "2-0-1-0", baseSets: 4, reps: "8-10", rest: 120, why: "Hyper variation SDT." },
                            { name: "Leg Curl Allongé", target: "ISCHIOS", tempo: "2-0-1-1", baseSets: 4, reps: "10-12", rest: 90, why: "Hyper ischios." },
                            { name: "Hip Thrust Machine", target: "FESSIERS", tempo: "2-0-1-1", baseSets: 3, reps: "12-15", rest: 90, why: "Hyper glutes." },
                            { name: "Fentes Sautées", target: "PLYO", tempo: "2-X-1-0", baseSets: 3, reps: "10", rest: 90, why: "Explosif + hyper." },
                            { name: "Mollets Machine", target: "MOLLETS", tempo: "2-0-1-1", baseSets: 4, reps: "15-20", rest: 60, why: "Hyper mollets." }
                        ],
                        'Vendredi': [
                            { name: "Dev. Incliné Machine", target: "PECS HAUT", tempo: "2-0-1-1", baseSets: 4, reps: "10-12", rest: 90, why: "Hyper machine." },
                            { name: "Elev. Latérales Câble", target: "DELTS", tempo: "2-0-1-1", baseSets: 4, reps: "12-15", rest: 60, why: "Hyper delts iso." },
                            { name: "Push-ups Lestés", target: "PECS/TRI", tempo: "2-0-1-0", baseSets: 3, reps: "10-12", rest: 90, why: "Hyper bodyweight." },
                            { name: "Ext Triceps Corde", target: "TRICEPS", tempo: "2-0-1-1", baseSets: 4, reps: "12-15", rest: 60, why: "Hyper triceps iso." },
                            { name: "Shoulder Press Machine", target: "ÉPAULES", tempo: "2-0-1-0", baseSets: 3, reps: "10-12", rest: 90, why: "Hyper force épaule." }
                        ],
                        'Samedi': [
                            { name: "Tirage Vertical Large", target: "DOS LARGE", tempo: "2-0-1-1", baseSets: 4, reps: "10-12", rest: 90, why: "Hyper largeur." },
                            { name: "Rowing Assis Machine", target: "DOS EPAIS", tempo: "2-0-1-1", baseSets: 4, reps: "10-12", rest: 90, why: "Hyper machine épaisseur." },
                            { name: "Face Pull Corde", target: "POSTURE", tempo: "2-0-1-1", baseSets: 4, reps: "15-20", rest: 60, why: "Hyper + santé." },
                            { name: "Curl Haltère Incliné", target: "BICEPS", tempo: "2-0-1-1", baseSets: 4, reps: "10-12", rest: 90, why: "Hyper biceps." },
                            { name: "Curl Marteau Corde", target: "BRACHIAL", tempo: "3-0-1-0", baseSets: 3, reps: "12-15", rest: 60, why: "Hyper brachial." }
                        ]
                    },
                    // PHASE 3 : DENSITÉ (Semaines 9-12)
                    phase3: {
                        'Lundi': [
                            { name: "Leg Press + Leg Ext (SS)", target: "CUISSES", tempo: "2-0-1-1", baseSets: 4, reps: "12-15", rest: 45, why: "Superset brûlage." },
                            { name: "Fentes sur Place", target: "FESSIERS", tempo: "2-0-1-0", baseSets: 3, reps: "15", rest: 60, why: "Tempo classique." },
                            { name: "Adducteur Machine", target: "INTÉRIEURS", tempo: "2-0-1-1", baseSets: 3, reps: "15-20", rest: 45, why: "Isolation métabolique." },
                            { name: "Mollets Machine", target: "MOLLETS", tempo: "2-1-1-1", baseSets: 4, reps: "20", rest: 45, why: "High volume." },
                            { name: "Torsion Abdominale", target: "ABS", tempo: "2-0-1-0", baseSets: 3, reps: "20", rest: 45, why: "Core métabolique." }
                        ],
                        'Mardi': [
                            { name: "Dev. Couché + Fly (SS)", target: "PECS", tempo: "2-0-1-1", baseSets: 4, reps: "12-15", rest: 45, why: "Superset densité." },
                            { name: "Rowing + Tirage (SS)", target: "DOS", tempo: "2-0-1-1", baseSets: 4, reps: "12-15", rest: 45, why: "Superset dos." },
                            { name: "Dev. Épaules Debout", target: "ÉPAULES", tempo: "2-0-1-0", baseSets: 3, reps: "12-15", rest: 60, why: "Densité shoulders." },
                            { name: "Dips Machine", target: "TRICEPS", tempo: "2-0-1-1", baseSets: 3, reps: "12-15", rest: 60, why: "Densité." },
                            { name: "Tirage Vert. Supination", target: "DOS LARGE", tempo: "2-0-1-1", baseSets: 3, reps: "12-15", rest: 60, why: "Variation largeur." }
                        ],
                        'Jeudi': [
                            { name: "SDT + Leg Curl (SS)", target: "ISCHIOS", tempo: "3-0-1-0", baseSets: 3, reps: "10/15", rest: 60, why: "Superset chaîne post." },
                            { name: "Curl + Hip Thrust (SS)", target: "GLUTES", tempo: "2-0-1-1", baseSets: 3, reps: "12-15", rest: 45, why: "Superset glute." },
                            { name: "Fentes Sautées", target: "PLYO", tempo: "2-X-1-0", baseSets: 3, reps: "15", rest: 60, why: "Densité explosive." },
                            { name: "Mollets Assis", target: "MOLLETS", tempo: "2-0-1-1", baseSets: 4, reps: "15-20", rest: 45, why: "Superset mollets." },
                            { name: "Reverse Hyper", target: "LOMBAIRES", tempo: "2-0-1-0", baseSets: 3, reps: "15", rest: 45, why: "Densité postérieur." }
                        ],
                        'Vendredi': [
                            { name: "Incliné + Flye (SS)", target: "HAUT PECS", tempo: "2-0-1-1", baseSets: 4, reps: "12-15", rest: 45, why: "Superset haut pecs." },
                            { name: "Elev. Lat + Shrugs (SS)", target: "DELTS", tempo: "2-0-1-1", baseSets: 4, reps: "15", rest: 45, why: "Superset épaules." },
                            { name: "Dips Poids du Corps", target: "PECS/TRI", tempo: "2-0-1-0", baseSets: 3, reps: "15", rest: 60, why: "Densité profonde." },
                            { name: "Ext Tri + Kickback (SS)", target: "TRICEPS", tempo: "2-0-1-1", baseSets: 4, reps: "15", rest: 45, why: "Superset triceps." },
                            { name: "Shoulder Press Machine", target: "ÉPAULES", tempo: "2-0-1-0", baseSets: 3, reps: "12-15", rest: 60, why: "Densité full shoulder." }
                        ],
                        'Samedi': [
                            { name: "Tract. + Tirage (SS)", target: "DOS LARGE", tempo: "3-0-1-0", baseSets: 4, reps: "10/15", rest: 60, why: "Superset densité." },
                            { name: "Rowing + Face Pull (SS)", target: "DOS EPAIS", tempo: "2-0-1-1", baseSets: 4, reps: "12-15", rest: 45, why: "Superset dos." },
                            { name: "Curl Barre + Reverse (SS)", target: "BICEPS", tempo: "2-0-1-0", baseSets: 4, reps: "12/15", rest: 60, why: "Superset biceps." },
                            { name: "Curl Marteau Machine", target: "BRACHIAL", tempo: "2-0-1-1", baseSets: 3, reps: "15", rest: 60, why: "Densité brachial." },
                            { name: "Tirage Neutre Serré", target: "DOS", tempo: "2-0-1-1", baseSets: 3, reps: "15", rest: 60, why: "Densité variation." }
                        ]
                    },
                    // PHASE 4 : DESTRUCTION (Semaines 13-16)
                    phase4: {
                        'Lundi': [
                            { name: "Squat+Press+Ext (TRI)", target: "CUISSES", tempo: "2-0-1-1", baseSets: 3, reps: "12/15/20", rest: 60, why: "Tri-set destruction." },
                            { name: "Fentes + Step-ups (SS)", target: "FESSIERS", tempo: "2-0-1-0", baseSets: 3, reps: "12/12", rest: 60, why: "Superset glute destruction." },
                            { name: "Abducteur Machine", target: "ABDUCTEURS", tempo: "2-0-1-1", baseSets: 3, reps: "20", rest: 45, why: "Isolation légère." },
                            { name: "Mollets Drop-Set", target: "MOLLETS", tempo: "Drop", baseSets: 3, reps: "15->25", rest: 45, why: "Drop-set destruction." },
                            { name: "Cable Crunch Lourd", target: "ABS", tempo: "2-0-1-0", baseSets: 3, reps: "15-20", rest: 45, why: "Core final." }
                        ],
                        'Mardi': [
                            { name: "Bench+Dips+Fly (TRI)", target: "PECS", tempo: "2-0-1-1", baseSets: 3, reps: "12/15/15", rest: 60, why: "Tri-set pecs destruction." },
                            { name: "Row+Pull+FacePull (TRI)", target: "DOS", tempo: "2-0-1-1", baseSets: 3, reps: "12/15/15", rest: 60, why: "Tri-set dos destruction." },
                            { name: "Dev. Épaules Drop-Set", target: "ÉPAULES", tempo: "Drop", baseSets: 3, reps: "12->20", rest: 60, why: "Drop-set épaules." },
                            { name: "Ext Triceps Machine", target: "TRICEPS", tempo: "2-0-1-1", baseSets: 3, reps: "15", rest: 60, why: "Isolation triceps." },
                            { name: "Tirage Neutre", target: "DOS LARGE", tempo: "2-0-1-1", baseSets: 3, reps: "15", rest: 60, why: "Variation final dos." }
                        ],
                        'Jeudi': [
                            { name: "SDT+Curl+Thrust (TRI)", target: "ISCHIOS", tempo: "Tri-set", baseSets: 3, reps: "8/15/15", rest: 90, why: "Tri-set chaîne post." },
                            { name: "Leg Curl Drop-Set", target: "ISCHIOS", tempo: "Drop", baseSets: 3, reps: "12->20", rest: 60, why: "Drop-set ischios." },
                            { name: "Bulgares+Sautées (SS)", target: "FESSIERS", tempo: "SS", baseSets: 3, reps: "12/15", rest: 60, why: "Superset fessiers." },
                            { name: "Mollets Debout Drop", target: "MOLLETS", tempo: "Drop", baseSets: 3, reps: "12->25", rest: 45, why: "Drop-set mollets." },
                            { name: "Hyper Ext Lestée", target: "LOMBAIRES", tempo: "2-0-1-0", baseSets: 3, reps: "12-15", rest: 60, why: "Force final." }
                        ],
                        'Vendredi': [
                            { name: "Incliné+Fly+Dips (TRI)", target: "PECS HAUT", tempo: "Tri-set", baseSets: 3, reps: "12/15/15", rest: 60, why: "Tri-set pecs haut." },
                            { name: "Elev. Latérales Drop", target: "DELTS", tempo: "Drop", baseSets: 3, reps: "15->25", rest: 45, why: "Drop-set delts." },
                            { name: "Press + Shrugs (SS)", target: "ÉPAULES", tempo: "SS", baseSets: 3, reps: "15/20", rest: 60, why: "Superset épaules." },
                            { name: "Rope + Kickback (SS)", target: "TRICEPS", tempo: "SS", baseSets: 3, reps: "15/20", rest: 45, why: "Superset triceps." },
                            { name: "Machine Presse", target: "ÉPAULES", tempo: "2-0-1-0", baseSets: 3, reps: "15", rest: 60, why: "Final destruction." }
                        ],
                        'Samedi': [
                            { name: "Pull+Vert+Row (TRI)", target: "DOS", tempo: "Tri-set", baseSets: 3, reps: "8/12/15", rest: 90, why: "Tri-set dos destruction." },
                            { name: "FacePull+RearFly (SS)", target: "POSTURE", tempo: "SS", baseSets: 3, reps: "15/15", rest: 60, why: "Superset arrière épaule." },
                            { name: "Curl Barre Drop-Set", target: "BICEPS", tempo: "Drop", baseSets: 3, reps: "10->20", rest: 60, why: "Drop-set biceps." },
                            { name: "Hammer+Reverse (SS)", target: "BRACHIAL", tempo: "SS", baseSets: 3, reps: "15/15", rest: 60, why: "Superset brachial." },
                            { name: "Tirage Pronation Serré", target: "DOS", tempo: "2-0-1-1", baseSets: 3, reps: "15", rest: 60, why: "Final dos variation." }
                        ]
                    }
                },

                initApp() {
                    lucide.createIcons();
                    this.selectedDay = this.getTodayName();
                    this.generateFact();
                    this.loadLocal(); // Chargement direct
                    this.calculateMacros();
                },

                // GESTION LOCAL STORAGE SIMPLIFIEE
                loadLocal() {
                    const d = JSON.parse(localStorage.getItem('superman_local_v1'));
                    if(d) {
                        this.currentWeight = d.currentWeight;
                        this.currentWeek = d.currentWeek || 1;
                        this.xp = d.xp || 0;
                        this.weightHistory = d.weightHistory || [];
                        this.history = d.history || {};
                        this.exerciseLogs = d.exerciseLogs || {};
                        this.completedSets = d.completedSets || {};
                        if (d.daily) this.daily = d.daily;
                    }
                },

                saveLocal() {
                    localStorage.setItem('superman_local_v1', JSON.stringify({
                        currentWeight: this.currentWeight,
                        currentWeek: this.currentWeek,
                        xp: this.xp,
                        weightHistory: this.weightHistory,
                        history: this.history,
                        exerciseLogs: this.exerciseLogs,
                        completedSets: this.completedSets,
                        daily: this.daily
                    }));
                },

                // LOGIQUE METIER
                openKeypad(target) { 
                    this.targetKey = target; 
                    this.tempWeight = target === 'bodyweight' ? this.currentWeight.toString() : (this.history[target] || "0").toString(); 
                    this.keypadOpen = true; 
                },
                closeKeypad() { this.keypadOpen = false; },
                appendDigit(digit) { if (this.tempWeight === "0" && digit !== ".") this.tempWeight = digit; else if (digit === "." && this.tempWeight.includes(".")) return; else this.tempWeight += digit; },
                backspace() { this.tempWeight = this.tempWeight.slice(0, -1); if (this.tempWeight === "") this.tempWeight = "0"; },
                adjustTempWeight(amount) { let val = parseFloat(this.tempWeight) || 0; val += amount; if(val < 0) val = 0; this.tempWeight = parseFloat(val.toFixed(2)).toString(); },
                
                confirmWeight() { 
                    const val = parseFloat(this.tempWeight); 
                    if (this.targetKey === 'bodyweight') { 
                        this.updateWeight(val - this.currentWeight); 
                    } else { 
                        this.history[this.targetKey] = val;
                        if(!this.exerciseLogs[this.targetKey]) this.exerciseLogs[this.targetKey] = [];
                        this.exerciseLogs[this.targetKey].push({ date: new Date().toLocaleDateString(), weight: val });
                        this.saveLocal();
                    } 
                    this.closeKeypad(); 
                },
                
                openExerciseInfo(ex) { 
                    this.activeExercise = ex; 
                    this.$nextTick(() => { setTimeout(() => { this.renderExerciseChart(ex.name); }, 300); });
                },

                openWeightHistory() { 
                    this.activeWeightModal = true; 
                    this.$nextTick(() => { setTimeout(() => { this.renderHistoryChart(); }, 300); });
                },

                startTimer(sec) { 
                    if(this.timer.interval) clearInterval(this.timer.interval); 
                    this.timer.total = sec; this.timer.current = sec; this.timer.active = true; 
                    this.timer.interval = setInterval(() => { 
                        this.timer.current--; 
                        if(this.timer.current <= 0) { this.stopTimer(); if(navigator.vibrate) navigator.vibrate([200,100,200]); } 
                    }, 1000); 
                },
                adjustTimer(sec) { this.timer.current += sec; if(this.timer.current < 0) this.timer.current = 0; if(this.timer.current > this.timer.total) this.timer.total = this.timer.current; },
                stopTimer() { this.timer.active = false; clearInterval(this.timer.interval); },

                // LOGIQUE CARDIO 16 SEMAINES
                getCardioWeekBlock() { 
                    const w = this.currentWeek; 
                    if(w<=4) return "PHASE 1 (1-4)"; 
                    if(w<=8) return "PHASE 2 (5-8)"; 
                    if(w<=12) return "PHASE 3 (9-12)";
                    return "PHASE 4 (13-16)"; 
                },
                getCardioData() {
                    const w = this.currentWeek;
                    // PHASE 1 : ACTIVATION (1-4)
                    if (w <= 2) {
                        return { focus: "PHASE 1: FOUNDATION", summary: "Tapis Intervalle Léger", calories: 150, speed: "3.5-5.5 km/h", incline: "0-1%", duration: "25 min", details: "5min warm (3.5km/h) | 4x (3min@5.5km/h + 2min@3.5km/h) | 5min cool.<br><span class='text-blue-400'>Zone 2 Cardiaque.</span>", science: "Zone 2, habituation sans stress." };
                    } else if (w <= 4) {
                        return { focus: "PHASE 1: PENTE", summary: "Tapis Intervalle Pente", calories: 200, speed: "4-5.5 km/h", incline: "0-3%", duration: "30 min", details: "5min warm | 5x (3min@5.5km/h Inc 3% + 2min@4km/h Flat) | 5min cool.", science: "Intégration pente progressive." };
                    } 
                    // PHASE 2 : INTENSIFICATION (5-8)
                    else if (w <= 6) {
                        return { focus: "PHASE 2: MONTAGNE", summary: "Tapis Pente Intense", calories: 280, speed: "5 km/h", incline: "2-10%", duration: "35 min", details: "5min warm | 25min circuit (2min@10% + 3min@2%) x5 | 5min cool.", science: "Pente élève FC sans impact." };
                    } else if (w <= 8) {
                        return { focus: "PHASE 2: ESCALIER", summary: "Stairmaster Initiation", calories: 220, speed: "Level 3-6", incline: "N/A", duration: "20 min", details: "5min warm | 10min (1min@Lvl6 + 2min@Lvl3) x4 | 5min cool.", science: "Force + cardio, zero impact." };
                    }
                    // PHASE 3 : HIIT LEGER (9-12)
                    else if (w <= 10) {
                        return { focus: "PHASE 3: HIIT TAPIS", summary: "12-5-30 Modifié", calories: 350, speed: "4.5-6 km/h", incline: "0-10%", duration: "38 min", details: "5min warm | 33min (3min@4.5km/h 10% + 2min@6km/h Flat) x6.", science: "Dépense massive, adaptation." };
                    } else if (w <= 12) {
                        return { focus: "PHASE 3: HIIT STAIRS", summary: "Stairmaster HIIT Light", calories: 280, speed: "Level 4-7", incline: "N/A", duration: "25 min", details: "5min warm | 15min (2min@Lvl7 + 1min@Lvl4) x5 | 5min cool.", science: "HIIT sans overtraining." };
                    }
                    // PHASE 4 : DESTRUCTION (13-16)
                    else if (w <= 14) {
                        return { focus: "PHASE 4: HARDCORE", summary: "12-4-30 MAX", calories: 420, speed: "4.5-6.5 km/h", incline: "0-12%", duration: "40 min", details: "5min warm | 30min (3min@12% + 2min@Flat) x6 | 5min cool.", science: "VO2 Max Push final." };
                    } else {
                        return { focus: "PHASE 4: DESTRUCTION", summary: "Stairmaster Brutal", calories: 400, speed: "Variable", incline: "N/A", duration: "30 min", details: "Montée continue. Toutes les 5min, 90sec SPRINT (Lvl 9 ou 2 marches).", science: "Brûlage maximal gras résiduel." };
                    }
                },
                
                toggleCardio() { this.daily.cardioDone = !this.daily.cardioDone; if (this.daily.cardioDone) { this.xp += 50; confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#f97316', '#fbbf24'] }); } else { this.xp -= 50; } this.saveLocal(); },
                openSupp(key) { this.activeSupp = key; }, openCardioInfo() { this.activeCardio = true; }, 
                generateFact() { this.randomFact = this.factsDatabase[Math.floor(Math.random() * this.factsDatabase.length)]; },
                calculateMacros() { const totalCalories = Math.round(this.currentWeight * 22); const protein = Math.round(this.currentWeight * 2.2); const fats = Math.round(this.currentWeight * 0.7); const calsFromProtFat = (protein * 4) + (fats * 9); const remainingCals = totalCalories - calsFromProtFat; const carbsHigh = Math.max(0, Math.round(remainingCals / 4)); const carbsLow = Math.max(0, Math.round((remainingCals * 0.5) / 4)); this.macros = { protein: protein, fats: fats, carbsHigh: carbsHigh, carbsLow: carbsLow, calories: totalCalories }; },
                getNutritionExplanation() { if(this.isHighCarb()) { return "Jour FORCE. Glucides modérés pour pousser lourd."; } else { return "Jour SÈCHE. Glucides bas pour forcer le corps à brûler le gras."; } },
                changeWeek(delta) { let next = this.currentWeek + delta; if(next < 1) next = 1; if(next > 16) next = 16; this.currentWeek = next; this.saveLocal(); },
                getSetsForWeek(ex) { let sets = ex.baseSets; return sets; },
                updateWeight(delta) { this.currentWeight = Math.round((this.currentWeight + delta) * 100) / 100; this.saveLocal(); },
                getSavedWeight(name) { return this.history[name] || 0; },
                getHistory(name) { return this.history[name] ? this.history[name] + 'kg' : '-'; },
                getTodayName() { const d = new Date().getDay(); const map = {1:'Lundi', 2:'Mardi', 3:'Mercredi', 4:'Jeudi', 5:'Vendredi', 6:'Samedi', 0:'Dimanche'}; return map[d] || 'Lundi'; },
                isHighCarb() { return ['Mardi', 'Jeudi'].includes(this.selectedDay); },
                startWorkoutSession() { this.tab = 'train'; const day = this.getTodayName(); this.selectedDay = (day === 'Samedi' || day === 'Dimanche') ? 'Lundi' : day; document.getElementById('scroller').scrollTo(0,0); },
                
                // NOUVEAU SELECTEUR D'EXERCICES PAR PHASE
                getExercises(day) { 
                    const w = this.currentWeek;
                    let phase = 'phase1';
                    if (w <= 4) phase = 'phase1';
                    else if (w <= 8) phase = 'phase2';
                    else if (w <= 12) phase = 'phase3';
                    else phase = 'phase4';
                    
                    return this.allPhases[phase][day] || []; 
                },

                isSetDone(day, exIdx, set) { return this.completedSets[`W${this.currentWeek}-${day}-${exIdx}-${set}`]; },
                toggleSet(day, exIdx, set, rest) { const k = `W${this.currentWeek}-${day}-${exIdx}-${set}`; if(this.completedSets[k]) { delete this.completedSets[k]; this.xp -= 10; } else { this.completedSets[k] = true; this.xp += 20; this.startTimer(rest); if(navigator.vibrate) navigator.vibrate(50); } this.saveLocal(); },
                finishWorkout() { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#3b82f6', '#ef4444'] }); this.xp += 100; this.saveLocal(); alert("SÉANCE TERMINÉE ! +100 XP"); this.tab = 'home'; },
                get xpProgress() { return (this.xp % 1000) / 10; },
                get userLevel() { return Math.floor(this.xp / 1000) + 1; },

                resetAll() { 
                    if(!confirm("Effacer toutes les données ?")) return; 
                    localStorage.removeItem('superman_local_v1');
                    location.reload(); 
                },

                renderHistoryChart() { 
                    const ctx = document.getElementById('weightHistoryChart'); 
                    if(!ctx) return; 
                    if(this.historyChartInstance) this.historyChartInstance.destroy(); 
                    const data = this.weightHistory.length ? this.weightHistory.map(x=>x.weight) : [105]; 
                    const labels = this.weightHistory.length ? this.weightHistory.map(x=>x.date) : ['Start']; 
                    this.historyChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Poids', data: data, borderColor: '#3b82f6', borderWidth: 3, backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { grid: { color: '#1e293b' } }, x: { display: false } } } }); 
                },
                renderExerciseChart(exName) {
                    const ctx = document.getElementById('exerciseChart');
                    if(!ctx) return;
                    if(this.exerciseChartInstance) this.exerciseChartInstance.destroy();
                    const logs = this.exerciseLogs[exName] || [];
                    const data = logs.length ? logs.map(l => l.weight) : [0];
                    const labels = logs.length ? logs.map(l => l.date) : ['Start'];
                    this.exerciseChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Charge (kg)', data: data, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 2, fill: true, tension: 0.3, pointRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#1e293b' }, beginAtZero: false }, x: { display: false } } } }); 
                }
            }
        }
    </script>
</body>
</html>